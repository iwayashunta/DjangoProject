{% extends "base.html" %}

{% block title %}SOS発信確認{% endblock %}

{% block content %}
<div class="max-w-md mx-auto bg-white rounded-xl shadow-md overflow-hidden md:max-w-2xl m-4">
    <div class="p-8 text-center">
        <h1 class="text-2xl font-bold text-gray-900 mb-4">位置情報を取得中...</h1>

        <p class="text-gray-600 mb-6" id="status-message">
            現在地を取得してSOSを発信します。<br>
            ブラウザの位置情報利用を許可してください。
        </p>

        <div class="flex justify-center mb-6" id="spinner">
            <!-- ローディングスピナー -->
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-red-500"></div>
        </div>

        <form id="sos-form" method="post" action="">
            {% csrf_token %}
            <input type="hidden" name="latitude" id="latitude">
            <input type="hidden" name="longitude" id="longitude">

            <button type="submit" id="submit-btn" class="hidden w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded focus:outline-none focus:shadow-outline">
                位置情報なしで発信する
            </button>
        </form>
    </div>
</div>

<script>
    const statusMsg = document.getElementById('status-message');
    const latInput = document.getElementById('latitude');
    const lonInput = document.getElementById('longitude');
    const form = document.getElementById('sos-form');
    const submitBtn = document.getElementById('submit-btn');
    const spinner = document.getElementById('spinner');

    let isProcessed = false; // 処理済みフラグ
    let successCount = 0; // ★デバッグ用: 成功コールバックの呼び出し回数

    function success(position) {
        successCount++;
        const lat = position.coords.latitude;
        const lon = position.coords.longitude;

        console.log(`[DEBUG] success callback called (${successCount}回目)`);
        console.log(`[DEBUG] 座標: ${lat}, ${lon}`);

        if (isProcessed) {
            console.log("[DEBUG] 既に処理済みのためスキップします");
            return;
        }
        isProcessed = true;

        latInput.value = lat;
        lonInput.value = lon;

        statusMsg.textContent = "位置情報を取得しました。送信中...";

        submitBtn.disabled = true;

        console.log("[DEBUG] フォームを送信します");
        form.submit();
    }

    function error(err) {
        if (isProcessed) return;

        console.warn(`ERROR(${err.code}): ${err.message}`);
        let msg = "位置情報の取得に失敗しました。";

        if (err.code === 1) {
            msg = "位置情報の利用が許可されませんでした。";
        } else if (err.code === 2) {
            msg = "位置情報を取得できませんでした（電波状況など）。";
        } else if (err.code === 3) {
            msg = "位置情報の取得がタイムアウトしました。";
        }

        if (window.location.protocol !== 'https:' && window.location.hostname !== 'localhost' && window.location.hostname !== '127.0.0.1') {
             msg += "<br>※セキュリティ制限により、HTTPS以外の通信では位置情報が取得できない場合があります。";
        }

        statusMsg.innerHTML = msg;
        spinner.classList.add('hidden');
        submitBtn.classList.remove('hidden');
        submitBtn.textContent = "位置情報なしで発信する";
    }

    form.addEventListener('submit', function(e) {
        if (isProcessed && latInput.value) {
            return;
        }

        e.preventDefault();

        if (isProcessed && !latInput.value) {
             return;
        }

        isProcessed = true;
        submitBtn.disabled = true;
        submitBtn.textContent = "送信中...";

        e.target.submit();
    });

    if (!navigator.geolocation) {
        statusMsg.textContent = "お使いのブラウザは位置情報に対応していません。";
        spinner.classList.add('hidden');
        submitBtn.classList.remove('hidden');
    } else {
        console.log("[DEBUG] 位置情報の取得を開始します...");
        navigator.geolocation.getCurrentPosition(success, error, {
            enableHighAccuracy: true,
            timeout: 15000,
            maximumAge: 0
        });
    }
</script>
{% endblock %}