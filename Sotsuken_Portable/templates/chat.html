{% extends "base.html" %}
{% block title %}ãƒãƒ£ãƒƒãƒˆ - {{ group.name }}{% endblock %}
{% block header_title %}{{ group.name }}{% endblock %}

{% block content %}
    <div class="flex flex-col h-[75vh]">

        <!-- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒªã‚¹ãƒˆ (è¦ªã‚³ãƒ³ãƒ†ãƒŠ) -->
        <!-- â˜…ã“ã“ã«ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’é›†ç´„ã—ã¾ã™ -->
        <div id="chat-log"
             class="flex-1 bg-white p-4 rounded-t-xl shadow-inner mb-4 overflow-y-auto space-y-4 relative">

            {# æˆ»ã‚‹ãƒœã‚¿ãƒ³ #}
            <div class="mb-2">
                <a href="javascript:void(0);" onclick="history.back();"
                   class="text-gray-500 hover:text-blue-600 flex items-center gap-1 text-sm font-semibold transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd"
                              d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z"
                              clip-rule="evenodd"/>
                    </svg>
                    æˆ»ã‚‹
                </a>
            </div>

            {# --- ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°åˆ† --- #}
            {% for msg in chat_messages %}
                <!-- IDã‚’ data-msg-id ã¨ã—ã¦ä¿æŒ -->
                <div id="msg-{{ msg.id }}"
                     class="message-container text-base mb-4 relative group {% if msg.sender.username == user.username %}text-right{% endif %}"
                     data-msg-id="{{ msg.id }}"
                     data-sender="{{ msg.sender.username }}">

                    <p class="font-bold text-sm text-gray-500">{{ msg.sender.full_name|default:msg.sender.username }}</p>

                    <div class="inline-block relative text-left">

                        <!-- å¹ãå‡ºã— (ã‚¯ãƒªãƒƒã‚¯å¯¾è±¡) -->
                        <!-- ã‚¯ãƒ©ã‚¹ `chat-bubble` ã‚’ç›®å°ã«ã—ã¾ã™ -->
                        <div class="chat-bubble cursor-pointer inline-block max-w-xs text-left break-words rounded-t-xl
                            {% if msg.image %}
                                bg-transparent border-0 p-0  {# â˜…ç”»åƒãªã‚‰èƒŒæ™¯ãªã—ãƒ»ä½™ç™½ãªã— #}
                            {% else %}
                                {% if msg.sender.username == user.username %}
                                    bg-blue-500 text-white rounded-bl-xl p-3
                                {% else %}
                                    bg-gray-200 rounded-br-xl p-3
                                {% endif %}
                            {% endif %}">

                            {% if msg.image %}
                                <img src="{{ msg.image.url }}"
                                     class="max-w-full h-auto rounded-xl border border-gray-200 pointer-events-none bg-white"
                                style="transform: translateZ(0);">
                            {% endif %}

                            {% if msg.content %}
                                <div class="{% if msg.image %}mt-1 p-2 rounded-lg {% if msg.sender.username == user.username %}bg-blue-500 text-white{% else %}bg-gray-200{% endif %}{% endif %}">
                                    {{ msg.content|urlize|linebreaksbr }}
                                </div>
                            {% endif %}
                        </div>

                        <!-- ãƒ¡ãƒ‹ãƒ¥ãƒ¼ (åˆæœŸçŠ¶æ…‹ã¯ hidden) -->
                        <div class="chat-menu hidden absolute z-20 bg-white shadow-xl border border-gray-200 rounded-lg p-1 min-w-[140px] flex flex-col gap-1 mt-1
                                    {% if msg.sender.username == user.username %}right-0{% else %}left-0{% endif %}">

                            {# ç”»åƒæ‹¡å¤§ #}
                            {% if msg.image %}
                                <a href="{{ msg.image.url }}" target="_blank"
                                   class="block text-left text-sm text-gray-700 px-3 py-2 hover:bg-gray-100 rounded no-underline">
                                    ğŸ” ç”»åƒã‚’æ‹¡å¤§
                                </a>
                            {% endif %}

                            {# å‰Šé™¤ (è‡ªåˆ†ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ã¿) #}
                            {% if msg.sender.username == user.username %}
                                <button type="button"
                                        class="btn-delete block w-full text-left text-sm text-red-600 px-3 py-2 hover:bg-red-50 rounded">
                                    ğŸ—‘ï¸ å‰Šé™¤ã™ã‚‹
                                </button>
                            {% endif %}
                        </div>

                    </div>
                </div>
            {% endfor %}
        </div>

        <!-- å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  -->
        <form id="chat-form" class="flex flex-col gap-2 p-2" autocomplete="off" enctype="multipart/form-data" onsubmit="return disableButton(this)">
            {% csrf_token %}
            <div class="flex items-center gap-2">
                <label class="text-sm text-gray-600 font-bold">æ·»ä»˜ç”»åƒ:</label>
                <input type="file" id="chat-image-input" accept="image/*"
                       class="text-sm text-gray-600 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
            </div>
            <div class="flex w-full items-end">
                <textarea id="chat-message-input" rows="1"
                          class="flex-1 p-3 border border-gray-300 rounded-l-xl focus:outline-none focus:ring-2 focus:ring-blue-500 text-base resize-none overflow-hidden"
                          placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›..."></textarea>
                <button type="submit" id="chat-message-submit"
                        class="bg-blue-600 text-white p-3 rounded-r-xl hover:bg-blue-700 font-semibold whitespace-nowrap h-full">
                    é€ä¿¡
                </button>
            </div>
        </form>
    </div>

    {{ group.id|json_script:"group-id" }}
    {{ user.username|json_script:"current-user-name" }}

    <!-- ... HTMLã®ä¸Šéƒ¨ã¯ãã®ã¾ã¾ ... -->

    <script>
        const groupId = JSON.parse(document.getElementById('group-id').textContent);
        const currentUserName = JSON.parse(document.getElementById('current-user-name').textContent);

        const chatLog = document.querySelector('#chat-log');
        const chatForm = document.querySelector('#chat-form');
        const chatMessageInput = document.querySelector('#chat-message-input');
        const chatImageInput = document.querySelector('#chat-image-input');
        const chatMessageSubmit = document.querySelector('#chat-message-submit');

        // =========================================================
        // 1. DOMæ“ä½œãƒ»è¡¨ç¤ºãƒ­ã‚¸ãƒƒã‚¯
        // =========================================================

        /**
         * ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ç”»é¢ã«è¿½åŠ ã™ã‚‹é–¢æ•°
         * @param {string|number} msgId - ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ID (ä»®ã®å ´åˆã¯ 'temp-xxx')
         * @param {string} senderUsername - é€ä¿¡è€…ã®ID
         * @param {string} message - ãƒ†ã‚­ã‚¹ãƒˆå†…å®¹
         * @param {string} imageUrl - ç”»åƒURL (ã¾ãŸã¯Blob URL)
         * @param {string} senderFullName - é€ä¿¡è€…åè¡¨ç¤ºç”¨
         * @param {boolean} isTemp - é€ä¿¡ä¸­ã®ä»®è¡¨ç¤ºã‹ã©ã†ã‹
         */
        function appendMessage(msgId, senderUsername, message, imageUrl, senderFullName, isTemp = false) {
            const isMe = (senderUsername === currentUserName);
            const displayName = senderFullName || senderUsername;

            // ã‚³ãƒ³ãƒ†ãƒŠä½œæˆ
            const msgContainer = document.createElement('div');
            msgContainer.id = 'msg-' + msgId;
            // å³å¯„ã›(text-right)ã®ã‚¯ãƒ©ã‚¹ä»˜ä¸
            msgContainer.className = `message-container text-base mb-4 relative group ${isMe ? 'text-right' : ''}`;

            // ä»®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å ´åˆã¯è­˜åˆ¥ç”¨ã‚¯ãƒ©ã‚¹ã‚’ã¤ã‘ã‚‹
            if (isTemp) {
                msgContainer.classList.add('message-temp', 'opacity-70'); // å°‘ã—è–„ãã™ã‚‹
            } else {
                msgContainer.dataset.msgId = msgId; // æ­£è¦IDã‚’ãƒ‡ãƒ¼ã‚¿å±æ€§ã«
            }

            // é€ä¿¡è€…å
            const senderP = document.createElement('p');
            senderP.className = 'font-bold text-sm text-gray-500 mb-1';
            senderP.textContent = displayName + (isTemp ? ' (é€ä¿¡ä¸­...)' : '');
            msgContainer.appendChild(senderP);

            // å¹ãå‡ºã—ãƒ©ãƒƒãƒ‘ãƒ¼
            const wrapper = document.createElement('div');
            wrapper.className = 'inline-block relative text-left';

            // å¹ãå‡ºã—æœ¬ä½“
            const bubble = document.createElement('div');

            // â˜…ãƒ‡ã‚¶ã‚¤ãƒ³ä¿®æ­£: ç”»åƒãŒã‚ã‚‹ã‹ã©ã†ã‹ã§ã‚¹ã‚¿ã‚¤ãƒ«ã‚’åˆ†å²
            let bubbleClass = "chat-bubble cursor-pointer rounded-t-xl inline-block max-w-xs text-left break-words";

            if (imageUrl) {
                // ç”»åƒã‚ã‚Š: èƒŒæ™¯ãªã—ãƒ»paddingãªã—
                bubbleClass += " bg-transparent";
            } else {
                // ãƒ†ã‚­ã‚¹ãƒˆã®ã¿: èƒŒæ™¯ã‚ã‚Šãƒ»paddingã‚ã‚Š
                if (isMe) {
                    bubbleClass += " bg-blue-500 text-white rounded-bl-xl p-3";
                } else {
                    bubbleClass += " bg-gray-200 rounded-br-xl p-3";
                }
            }
            bubble.className = bubbleClass;

            // ç”»åƒã®è¡¨ç¤º
            if (imageUrl) {
                let fullImageUrl = imageUrl;
                // HTTPã§å§‹ã¾ã‚‰ãªã„ãƒ‘ã‚¹(mediaãƒ‘ã‚¹)ãªã‚‰ã‚ªãƒªã‚¸ãƒ³ã‚’ä»˜ä¸ã€‚Blobãªã‚‰ãã®ã¾ã¾ã€‚
                if (!imageUrl.startsWith('http') && !imageUrl.startsWith('blob:')) {
                    fullImageUrl = window.location.origin + imageUrl;
                }
                const img = document.createElement('img');
                img.src = fullImageUrl;
                // èƒŒæ™¯ã‚’ç™½ã«ã—ã¦é€éç”»åƒã®æ··è‰²ã‚’é˜²ã + è–„ã„æ ç·š
                img.className = "max-w-full h-auto rounded-xl border border-gray-200 mb-1 pointer-events-none bg-white";
                img.style.transform = "translateZ(0)";
                bubble.appendChild(img);
            }

            // ãƒ†ã‚­ã‚¹ãƒˆã®è¡¨ç¤º
            if (message) {
                const textSpan = document.createElement('span');
                textSpan.innerHTML = urlify(escapeHtml(message));
                bubble.appendChild(textSpan);
            }

            wrapper.appendChild(bubble);

            // ãƒ¡ãƒ‹ãƒ¥ãƒ¼ (ä»®è¡¨ç¤ºã®ã¨ãã¯ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’å‡ºã•ãªã„)
            if (!isTemp) {
                const menu = document.createElement('div');
                menu.className = `chat-menu hidden absolute z-20 bg-white shadow-xl border border-gray-200 rounded-lg p-1 min-w-[140px] flex flex-col gap-1 mt-1 ${isMe ? 'right-0' : 'left-0'}`;

                // ç”»åƒæ‹¡å¤§
                if (imageUrl) {
                    let fullImageUrl = (imageUrl.startsWith('http') || imageUrl.startsWith('blob:')) ? imageUrl : window.location.origin + imageUrl;
                    const viewLink = document.createElement('a');
                    viewLink.href = fullImageUrl;
                    viewLink.target = '_blank';
                    viewLink.className = 'block text-left text-sm text-gray-700 px-3 py-2 hover:bg-gray-100 rounded no-underline';
                    viewLink.textContent = 'ğŸ” ç”»åƒã‚’æ‹¡å¤§';
                    menu.appendChild(viewLink);
                }

                // å‰Šé™¤ (è‡ªåˆ†ã®ã¿)
                if (isMe) {
                    const delBtn = document.createElement('button');
                    delBtn.type = 'button';
                    delBtn.className = 'btn-delete block w-full text-left text-sm text-red-600 px-3 py-2 hover:bg-red-50 rounded';
                    delBtn.textContent = 'ğŸ—‘ï¸ å‰Šé™¤ã™ã‚‹';
                    menu.appendChild(delBtn);
                }
                wrapper.appendChild(menu);
            }

            msgContainer.appendChild(wrapper);
            chatLog.appendChild(msgContainer);

            // ä¸‹ã¾ã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
            chatLog.scrollTop = chatLog.scrollHeight;
        }


        // =========================================================
        // 2. ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š (ãƒ¡ãƒ‹ãƒ¥ãƒ¼æ“ä½œãƒ»é€ä¿¡)
        // =========================================================

        // ãƒ¡ãƒ‹ãƒ¥ãƒ¼é–‹é–‰ (ã‚¤ãƒ™ãƒ³ãƒˆå§”è­²)
        chatLog.addEventListener('click', function (e) {
            const bubble = e.target.closest('.chat-bubble');
            if (bubble) {
                e.stopPropagation();
                const menu = bubble.nextElementSibling;
                if (menu && menu.classList.contains('chat-menu')) {
                    closeAllMenus();
                    menu.classList.remove('hidden');
                }
                return;
            }

            const deleteBtn = e.target.closest('.btn-delete');
            if (deleteBtn) {
                e.preventDefault();
                if (confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                    const msgContainer = deleteBtn.closest('.message-container');
                    const msgId = msgContainer.dataset.msgId;
                    if (msgId) deleteMessage(msgId);
                }
                closeAllMenus();
                return;
            }
        });

        document.addEventListener('click', function () {
            closeAllMenus();
        });

        function closeAllMenus() {
            document.querySelectorAll('.chat-menu').forEach(menu => {
                menu.classList.add('hidden');
            });
        }


        // =========================================================
        // 3. é€ä¿¡ãƒ•ã‚©ãƒ¼ãƒ å‡¦ç† (â˜…å³æ™‚åæ˜ ã®å®Ÿè£…)
        // =========================================================

        chatForm.onsubmit = function (e) {
            e.preventDefault();
            const submitBtn = document.querySelector('#chat-message-submit');
            if (submitBtn.disabled) return;
            const message = chatMessageInput.value;
            const imageFile = chatImageInput.files[0];

            if (message.trim() === '' && !imageFile) return;

            submitBtn.disabled = true;
            submitBtn.textContent = 'é€ä¿¡ä¸­...'; // ãƒ†ã‚­ã‚¹ãƒˆã‚’å¤‰ãˆã‚‹ã¨è¦ªåˆ‡
            submitBtn.classList.add('opacity-50', 'cursor-not-allowed'); // Tailwindã§è–„ãã™ã‚‹

            // --- A. å³æ™‚åæ˜  (ä»®è¡¨ç¤º) ---
            const tempId = 'temp-' + Date.now();
            let previewUrl = null;
            if (imageFile) {
                // ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”¨URLã‚’ç”Ÿæˆ
                previewUrl = URL.createObjectURL(imageFile);
            }

            // è‡ªåˆ†ã®ç™ºè¨€ã¨ã—ã¦ç”»é¢ã«è¿½åŠ  (isTemp=true)
            // ã“ã‚Œã§ã€Œé€ä¿¡ç›´å¾Œã€ã«ã€Œå³å¯„ã›ã€ã§è¡¨ç¤ºã•ã‚Œã¾ã™
            appendMessage(tempId, currentUserName, message, previewUrl, null, true);

            // --- B. ã‚µãƒ¼ãƒãƒ¼é€ä¿¡ ---
            const formData = new FormData();
            formData.append('group_id', groupId);
            formData.append('message', message);
            if (imageFile) formData.append('image', imageFile);

            const apiUrl = '/api/post-group-message/';

            // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ã‚¯ãƒªã‚¢
            chatMessageInput.value = '';
            chatImageInput.value = '';
            chatMessageInput.style.height = 'auto';

            fetch(apiUrl, {
                method: 'POST',
                body: formData,
                headers: {'X-CSRFToken': getCookie('csrftoken')}
            }).then(response => {
                if (!response.ok) {
                    alert('é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ');
                    // å¤±æ•—ã—ãŸã‚‰ä»®è¡¨ç¤ºã‚’æ¶ˆã™ãªã©ã®å‡¦ç†ãŒå¿…è¦ã§ã™ãŒä»Šå›ã¯çœç•¥
                }
            }).catch(err => {
                console.error(err);
                alert('é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
            })
            .finally(() => {
            // â˜…è¿½åŠ 4: æˆåŠŸãƒ»å¤±æ•—ã«é–¢ã‚ã‚‰ãšã€æœ€å¾Œã«ãƒœã‚¿ãƒ³ã‚’å¾©æ´»ã•ã›ã‚‹
            submitBtn.disabled = false;
            submitBtn.textContent = 'é€ä¿¡';
            submitBtn.classList.remove('opacity-50', 'cursor-not-allowed');

            // PCãªã‚‰å…¥åŠ›æ¬„ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’æˆ»ã™
            chatMessageInput.focus();
            });
        };

        // =========================================================
        // 4. WebSocketå—ä¿¡å‡¦ç† (â˜…é‡è¤‡æ’é™¤)
        // =========================================================
        const ws_scheme = window.location.protocol === "https:" ? "wss" : "ws";
        const chatSocket = new WebSocket(
            ws_scheme + '://' + window.location.host + '/ws/chat/group/' + groupId + '/'
        );

        chatSocket.onmessage = function (e) {
            const data = JSON.parse(e.data);

            // â˜…ãƒ‡ãƒãƒƒã‚°ç”¨ãƒ­ã‚°
            console.log("WebSocketå—ä¿¡:", data);
            console.log("è‡ªåˆ†(JS):", currentUserName, " é€ä¿¡è€…(Server):", data.sender);
            console.log("åˆ¤å®šçµæœ:", data.sender === currentUserName);

            if (data.type === 'delete') {
                const msgElement = document.getElementById('msg-' + data.message_id);
                if (msgElement) msgElement.remove();

            } else {
                // æ–°è¦ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å—ä¿¡

                // â˜…ä¿®æ­£: äºŒé‡è¡¨ç¤ºå¯¾ç­–
                const tempMsgs = document.querySelectorAll('.message-temp');
                if (tempMsgs.length > 0) {
                    tempMsgs.forEach(el => el.remove());
                }

                appendMessage(data.id, data.sender, data.message, data.image_url, data.sender_full_name);
            }
        };

        // --- ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ---
        function deleteMessage(msgId) {
            const formData = new FormData();
            formData.append('message_id', msgId);
            fetch('/api/delete-message/', {
                method: 'POST',
                body: formData,
                headers: {'X-CSRFToken': getCookie('csrftoken')}
            }).then(res => {
                if (!res.ok) alert('å‰Šé™¤ã‚¨ãƒ©ãƒ¼');
            });
        }

        function escapeHtml(text) {
            if (!text) return "";
            return text.replace(/[&<>"']/g, function (m) {
                return {'&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;'}[m];
            });
        }

        function urlify(text) {
            const urlRegex = /(https?:\/\/[^\s]+)/g;
            return text.replace(urlRegex, '<a href="$&" target="_blank" class="underline hover:text-blue-200" onclick="event.stopPropagation()">$&</a>').replace(/\n/g, '<br>');
        }

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢è‡ªå‹•ãƒªã‚µã‚¤ã‚º
        chatMessageInput.addEventListener('input', function () {
            this.style.height = 'auto';
            this.style.height = (this.style.scrollHeight) + 'px';
        });
        chatMessageInput.addEventListener('keydown', function (e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                chatMessageSubmit.click();
            }
        });
    </script>
{% endblock %}