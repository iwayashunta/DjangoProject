{% extends "base.html" %}
{% block title %}チャット - {{ group.name }}{% endblock %}
{% block header_title %}{{ group.name }}{% endblock %}

{% block content %}
<div class="flex flex-col h-[75vh]">
    <!-- メッセージリスト -->
    <div id="chat-log" class="flex-1 bg-white p-4 rounded-t-xl shadow-inner mb-4 overflow-y-auto space-y-4">
    </div>

    <!-- メッセージ入力フォーム -->
    <form id="chat-form" class="flex">
        <input type="text" id="chat-message-input" class="flex-1 p-3 border border-gray-300 rounded-l-xl focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="メッセージを入力...">
        <button type="submit" id="chat-message-submit" class="bg-blue-600 text-white p-3 rounded-r-xl hover:bg-blue-700 font-semibold">送信</button>
    </form>
</div>

{{ group.id|json_script:"group-id" }}
{{ user.full_name|default:user.email|json_script:"current-user-name" }}

<script>
    const groupId = JSON.parse(document.getElementById('group-id').textContent);
    const currentUserName = JSON.parse(document.getElementById('current-user-name').textContent);

    const chatLog = document.querySelector('#chat-log');
    const chatForm = document.querySelector('#chat-form');
    const chatMessageInput = document.querySelector('#chat-message-input');

    const chatSocket = new WebSocket('ws://localhost:8765/');

    chatSocket.onopen = function(e) {
        console.log('WebSocketに接続しました。');
        chatSocket.send(JSON.stringify({
            'type': 'join',
            'group_id': groupId,
            'username': currentUserName
        }));
    };

    chatSocket.onmessage = function(e) {
        const response = JSON.parse(e.data);

        if (response.type === 'history') {
            chatLog.innerHTML = '';
            response.messages.forEach(function(data) {
                appendMessage(data);
            });
        } else if (response.type === 'message') {
            appendMessage(response.data);
        }
    };

    chatSocket.onclose = function(e) {
        console.error('WebSocket接続が切れました。');
    };

    // --- ここから修正 ---

    // フォーム送信時の処理を記述
    chatForm.onsubmit = function(e) {
        e.preventDefault();
        const message = chatMessageInput.value;
        if (message.trim() !== '') {
            chatSocket.send(JSON.stringify({
                'type': 'message',
                'message': message
            }));
            chatMessageInput.value = '';
        }
    };

    // メッセージ描画関数の処理を記述
    function appendMessage(data) {
        const sender = data.sender;
        const message = data.message;
        const isMe = (sender === currentUserName);

        const messageDiv = document.createElement('div');
        messageDiv.className = 'text-sm' + (isMe ? ' text-right' : '');

        const senderP = document.createElement('p');
        senderP.className = 'font-bold text-xs text-gray-500';
        senderP.textContent = sender;

        const contentP = document.createElement('p');
        contentP.className = (isMe ? 'bg-blue-500 text-white' : 'bg-gray-200') +
                             ' p-3 rounded-t-xl' +
                             (isMe ? ' rounded-bl-xl' : ' rounded-br-xl') +
                             ' inline-block max-w-xs text-left'; // text-leftを追加

        contentP.textContent = message;

        messageDiv.appendChild(senderP);
        messageDiv.appendChild(contentP);
        chatLog.appendChild(messageDiv);

        // 常に一番下にスクロール
        chatLog.scrollTop = chatLog.scrollHeight;
    }
    // --- ここまで修正 ---

</script>
{% endblock %}