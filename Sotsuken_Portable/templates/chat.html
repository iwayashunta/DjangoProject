{% extends "base.html" %}
{% block title %}ãƒãƒ£ãƒƒãƒˆ - {{ group.name }}{% endblock %}
{% block header_title %}{{ group.name }}{% endblock %}

{% block content %}
    <div class="flex flex-col h-[75vh]">
        <!-- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒªã‚¹ãƒˆ -->
        <div id="chat-log" class="flex-1 bg-white p-4 rounded-t-xl shadow-inner mb-4 overflow-y-auto space-y-4">
            {# â–¼â–¼â–¼ è¿½åŠ : ç›´å‰ã®ãƒšãƒ¼ã‚¸ã«æˆ»ã‚‹ãƒœã‚¿ãƒ³ â–¼â–¼â–¼ #}
            <div class="mb-2">
                <a href="javascript:void(0);" onclick="history.back();"
                   class="text-gray-500 hover:text-blue-600 flex items-center gap-1 text-sm font-semibold transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd"
                              d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z"
                              clip-rule="evenodd"/>
                    </svg>
                    æˆ»ã‚‹
                </a>
            </div>
            {# --- ã“ã“ã‹ã‚‰ä¿®æ­£ãƒ»è¿½åŠ  --- #}
            {# ãƒ“ãƒ¥ãƒ¼ã‹ã‚‰æ¸¡ã•ã‚ŒãŸéå»ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ãƒ«ãƒ¼ãƒ—ã§è¡¨ç¤º #}
            {% for msg in chat_messages %}
                <!-- Alpine.jsã§ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®é–‹é–‰çŠ¶æ…‹(menuOpen)ã‚’ç®¡ç† -->
                <div id="msg-{{ msg.id }}"
                     class="text-base mb-4 relative group {% if msg.sender == user %}text-right{% endif %}"
                     x-data="{ menuOpen: false }">

                    <p class="font-bold text-sm text-gray-500">{{ msg.sender.full_name|default:msg.sender.username }}</p>

                    <div class="inline-block relative text-left">

                        <!-- å¹ãå‡ºã—éƒ¨åˆ†: ã‚¯ãƒªãƒƒã‚¯ã§ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‹é–‰ -->
                        <div @click="menuOpen = !menuOpen"
                             @click.outside="menuOpen = false"
                             class="cursor-pointer {% if msg.sender == user %}bg-blue-500 text-white{% else %}bg-gray-200{% endif %} p-3 rounded-t-xl {% if msg.sender == user %}rounded-bl-xl{% else %}rounded-br-xl{% endif %} inline-block max-w-xs text-left break-words">

                            {% if msg.image %}
                                <!-- ãƒªãƒ³ã‚¯(aã‚¿ã‚°)ã‚’å¤–ã—ã¦ã€å˜ãªã‚‹ç”»åƒã«ã—ã¾ã™ -->
                                <img src="{{ msg.image.url }}"
                                     class="max-w-full h-auto rounded-lg mb-1 pointer-events-none">
                            {% endif %}

                            {{ msg.content|urlize|linebreaksbr }}
                        </div>

                        <!-- ãƒ¡ãƒ‹ãƒ¥ãƒ¼éƒ¨åˆ† (æœ€åˆã¯éè¡¨ç¤º) -->
                        <div x-show="menuOpen"
                             x-transition
                             style="display: none;"
                             class="absolute z-20 bg-white shadow-xl border border-gray-200 rounded-lg p-1 min-w-[140px] flex flex-col gap-1 mt-1
                                    {% if msg.sender == user %}right-0{% else %}left-0{% endif %}">

                            {# 1. ç”»åƒæ‹¡å¤§ãƒœã‚¿ãƒ³ (ç”»åƒãŒã‚ã‚‹å ´åˆã®ã¿) #}
                            {% if msg.image %}
                                <a href="{{ msg.image.url }}" target="_blank"
                                   class="block text-left text-sm text-gray-700 px-3 py-2 hover:bg-gray-100 rounded no-underline">
                                    ğŸ” ç”»åƒã‚’æ‹¡å¤§
                                </a>
                            {% endif %}

                            {# 2. å‰Šé™¤ãƒœã‚¿ãƒ³ (è‡ªåˆ†ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ã¿) #}
                            {% if msg.sender == user %}
                                <button onclick="if(confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) deleteMessage({{ msg.id }})"
                                        class="block w-full text-left text-sm text-red-600 px-3 py-2 hover:bg-red-50 rounded">
                                    ğŸ—‘ï¸ å‰Šé™¤ã™ã‚‹
                                </button>
                            {% endif %}
                        </div>

                    </div>
                </div>
            {% endfor %}
            {# --- ã“ã“ã¾ã§ä¿®æ­£ãƒ»è¿½åŠ  --- #}

        </div>

        <!-- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  -->
        <form id="chat-form" class="flex flex-col gap-2 p-2" autocomplete="off" enctype="multipart/form-data">
            {% csrf_token %}

            <!-- â˜…â˜…â˜… ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆä¿®æ­£: flex-col ã§ç¸¦ä¸¦ã³ã«ã—ã¦ã„ã¾ã™ â˜…â˜…â˜… -->

            <!-- ç”»åƒé¸æŠãƒœã‚¿ãƒ³ -->
            <div class="flex items-center gap-2">
                <label class="text-sm text-gray-600 font-bold">æ·»ä»˜ç”»åƒ:</label>
                <input type="file" id="chat-image-input" accept="image/*"
                       class="text-sm text-gray-600 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
            </div>

            <!-- items-end ã‚’è¿½åŠ ã—ã¦ã€å…¥åŠ›æ¬„ãŒä¼¸ã³ãŸã¨ãã«ãƒœã‚¿ãƒ³ãŒä¸‹ã«æƒã†ã‚ˆã†ã«ã™ã‚‹ -->
            <div class="flex w-full items-end">
                <textarea id="chat-message-input" rows="1"
                          class="flex-1 p-3 border border-gray-300 rounded-l-xl focus:outline-none focus:ring-2 focus:ring-blue-500 text-base resize-none overflow-hidden"
                          placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›..."></textarea>
                <button type="submit" id="chat-message-submit"
                        class="bg-blue-600 text-white p-3 rounded-r-xl hover:bg-blue-700 font-semibold whitespace-nowrap h-full">
                    é€ä¿¡
                </button>
            </div>
        </form>
    </div>

    {{ group.id|json_script:"group-id" }}
    {{ user.full_name|default:user.username|json_script:"current-user-name" }}

    <script>
        const groupId = JSON.parse(document.getElementById('group-id').textContent);
        const currentUserName = JSON.parse(document.getElementById('current-user-name').textContent);

        const chatLog = document.querySelector('#chat-log');
        const chatMessageInput = document.querySelector('#chat-message-input');
        const chatForm = document.querySelector('#chat-form');
        // --- ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã®è‡ªå‹•ãƒªã‚µã‚¤ã‚ºã¨Enteré€ä¿¡ ---
        const chatMessageSubmit = document.querySelector('#chat-message-submit'); // ãƒœã‚¿ãƒ³å–å¾—

        chatMessageInput.addEventListener('input', function () {
            this.style.height = 'auto'; // ä¸€æ—¦é«˜ã•ã‚’ãƒªã‚»ãƒƒãƒˆ
            this.style.height = (this.style.scrollHeight) + 'px'; // æ–‡å­—é‡ã«åˆã‚ã›ã¦é«˜ã•ã‚’è¨­å®š

            // æœ€å¤§ã®é«˜ã•ï¼ˆä¾‹ãˆã°150pxï¼‰ã‚’è¶…ãˆãŸã‚‰ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã•ã›ã‚‹å ´åˆ
            if (this.scrollHeight > 150) {
                this.style.overflowY = "scroll";
            } else {
                this.style.overflowY = "hidden";
            }
        });

        chatMessageInput.addEventListener('keydown', function (e) {
            // Enterã‚­ãƒ¼ãŒæŠ¼ã•ã‚ŒãŸã¨ãï¼ˆShiftã‚­ãƒ¼ã¯æŠ¼ã•ã‚Œã¦ã„ãªã„å ´åˆï¼‰
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault(); // æ”¹è¡Œã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                chatMessageSubmit.click(); // é€ä¿¡ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã“ã¨ã«ã™ã‚‹
            }
        });


        // --- XSSå¯¾ç­–: HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—é–¢æ•° ---
        function escapeHtml(text) {
            if (!text) return text;
            return text
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // --- WebSocketé–¢é€£ã®ãƒ­ã‚¸ãƒƒã‚¯ã¯å¤‰æ›´ãªã— ---
        // httpsãªã‚‰wssã€httpãªã‚‰wsã‚’è‡ªå‹•é¸æŠ
        const ws_scheme = window.location.protocol === "https:" ? "wss" : "ws";
        const chatSocket = new WebSocket(
            ws_scheme + '://' + window.location.host + '/ws/chat/group/' + groupId + '/'
        );

        chatSocket.onopen = function (e) {
            console.log('Chat socket connected successfully');
        };

        chatSocket.onclose = function (e) {
            console.error('WebSocketæ¥ç¶šãŒåˆ‡ã‚Œã¾ã—ãŸã€‚');
        };

        chatSocket.onmessage = function (e) {
            const data = JSON.parse(e.data);
            // â˜… åˆ†å²: ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å—ä¿¡ã‹ã€å‰Šé™¤é€šçŸ¥ã‹
            if (data.type === 'delete') {
                // è©²å½“ã™ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ç”»é¢ã‹ã‚‰æ¶ˆã™
                const msgElement = document.getElementById('msg-' + data.message_id);
                if (msgElement) {
                    msgElement.remove();
                }
            } else {
                // é€šå¸¸ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å—ä¿¡
                // å¼•æ•°ã« id ã‚’è¿½åŠ 
                appendMessage(data.id, data.sender, data.message, data.image_url);
            }
        };

        // â˜…è¿½åŠ : å‰Šé™¤ãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡é–¢æ•°
        function deleteMessage(msgId) {
            const formData = new FormData();
            formData.append('message_id', msgId);

            fetch('/api/delete-message/', {
                method: 'POST',
                body: formData,
                headers: {'X-CSRFToken': getCookie('csrftoken')}
            }).then(response => {
                if (!response.ok) alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
            });
        }


        // â˜…é‡è¦: CSRFãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—ã™ã‚‹é–¢æ•°
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        const chatImageInput = document.querySelector('#chat-image-input'); // è¿½åŠ 

        chatForm.onsubmit = function (e) {
            e.preventDefault();
            const message = chatMessageInput.value;
            const imageFile = chatImageInput.files[0]; // ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—

            // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚‚ç”»åƒã‚‚ãªã‘ã‚Œã°ä½•ã‚‚ã—ãªã„
            if (message.trim() === '' && !imageFile) {
                return;
            }

            // â˜… WebSocketé€ä¿¡ã‚’ã‚„ã‚ã¦ã€FormDataã‚’ä½¿ã£ãŸPOSTé€ä¿¡ã«å¤‰æ›´
            const formData = new FormData();
            formData.append('group_id', groupId);
            formData.append('message', message);
            if (imageFile) {
                formData.append('image', imageFile);
            }

            // APIã®URL (ãƒ©ã‚ºãƒ‘ã‚¤ã¨åŒã˜APIã‚’å©ã)
            // â€» api/ ãŒurls.pyã®ã©ã“ã«ã‚ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚é€šå¸¸ã¯ /api/post-group-message/
            const apiUrl = '/api/post-group-message/';

            fetch(apiUrl, {
                method: 'POST',
                body: formData,
                headers: {
                    // 'Content-Type': 'multipart/form-data', // â˜…é‡è¦: ã“ã‚Œã¯æŒ‡å®šã—ã¦ã¯ã„ã‘ã¾ã›ã‚“ (ãƒ–ãƒ©ã‚¦ã‚¶ãŒè‡ªå‹•è¨­å®šã—ã¾ã™)
                    'X-CSRFToken': getCookie('csrftoken') // CSRFå¯¾ç­–
                }
            })
                .then(response => {
                    if (response.ok) {
                        // é€ä¿¡æˆåŠŸã—ãŸã‚‰ãƒ•ã‚©ãƒ¼ãƒ ã‚’ã‚¯ãƒªã‚¢
                        chatMessageInput.value = '';
                        chatImageInput.value = ''; // ç”»åƒé¸æŠã‚‚ã‚¯ãƒªã‚¢
                        chatMessageInput.style.height = 'auto';
                    } else {
                        console.error('é€ä¿¡ã‚¨ãƒ©ãƒ¼');
                        alert('ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
                    }
                })
                .catch(error => {
                    console.error('é€šä¿¡ã‚¨ãƒ©ãƒ¼:', error);
                });
        };

        function appendMessage(msgId, sender, message, imageUrl) {
            const isMe = (sender === currentUserName);

            const messageDiv = document.createElement('div');
            if (msgId) {
                messageDiv.id = 'msg-' + msgId;
            }
            messageDiv.className = 'text-base mb-4 relative group' + (isMe ? ' text-right' : '');

            const senderP = document.createElement('p');
            senderP.className = 'font-bold text-sm text-gray-500 mb-1';
            senderP.textContent = sender;

            // ã‚³ãƒ³ãƒ†ãƒŠï¼ˆå¹ãå‡ºã—ï¼‹ãƒ¡ãƒ‹ãƒ¥ãƒ¼ï¼‰
            const bubbleContainer = document.createElement('div');
            bubbleContainer.className = 'inline-block relative';

            const contentP = document.createElement('div');
            contentP.className = (isMe ? 'bg-blue-500 text-white' : 'bg-gray-200') +
                ' p-3 rounded-t-xl' +
                (isMe ? ' rounded-bl-xl' : ' rounded-br-xl') +
                ' text-left break-words max-w-xs';

            // --- ç”»åƒã®å‡¦ç† ---
            if (imageUrl) {
                let fullImageUrl = imageUrl;
                if (!imageUrl.startsWith('http')) {
                    fullImageUrl = window.location.origin + imageUrl;
                }

                const img = document.createElement('img');
                img.src = fullImageUrl;
                // ç”»åƒè‡ªä½“ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã‚‚åå¿œã•ã›ãšã€è¦ª(contentP)ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™ºç«ã•ã›ã‚‹
                img.className = "max-w-full h-auto rounded-lg mb-1 pointer-events-none";

                contentP.appendChild(img);
            }

            // --- ãƒ†ã‚­ã‚¹ãƒˆã®å‡¦ç† ---
            function urlify(text) {
                const urlRegex = /(https?:\/\/[^\s]+)/g;
                return text
                    .replace(urlRegex, '<a href="$&" target="_blank" class="underline hover:text-blue-200" onclick="event.stopPropagation()">$&</a>')
                    .replace(/\n/g, '<br>');
            }

            if (message) {
                const textSpan = document.createElement('span');
                const safeText = escapeHtml(message);
                textSpan.innerHTML = urlify(safeText);
                contentP.appendChild(textSpan);
            }

            bubbleContainer.appendChild(contentP);

            // =========================================================
            // â˜…ãƒ¡ãƒ‹ãƒ¥ãƒ¼ï¼ˆå‰Šé™¤ãƒ»ç”»åƒè¡¨ç¤ºï¼‰ã®ä½œæˆãƒ­ã‚¸ãƒƒã‚¯ä¿®æ­£
            // =========================================================

            // ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãŒå¿…è¦ãªæ¡ä»¶: ã€Œè‡ªåˆ†ãŒé€ä¿¡è€…(å‰Šé™¤ç”¨)ã€ã¾ãŸã¯ã€Œç”»åƒãŒã‚ã‚‹(è¡¨ç¤ºç”¨)ã€
            const needsMenu = (isMe && msgId) || imageUrl;

            if (needsMenu) {
                contentP.style.cursor = 'pointer'; // ã‚¿ãƒƒãƒ—ã§ãã‚‹ã“ã¨ã‚’ç¤ºã™

                // ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚³ãƒ³ãƒ†ãƒŠä½œæˆ
                const menuDiv = document.createElement('div');
                menuDiv.className = 'hidden absolute z-10 bg-white shadow-xl border border-gray-200 rounded-lg p-1 min-w-[140px] flex flex-col gap-1';

                // ä½ç½®èª¿æ•´
                if (isMe) {
                    menuDiv.classList.add('top-full', 'right-0', 'mt-1');
                } else {
                    menuDiv.classList.add('top-full', 'left-0', 'mt-1');
                }

                // 1. [å…¨å“¡] ç”»åƒã‚’è¦‹ã‚‹ãƒœã‚¿ãƒ³ï¼ˆç”»åƒãŒã‚ã‚‹å ´åˆã®ã¿ï¼‰
                if (imageUrl) {
                    let fullImageUrl = imageUrl;
                    if (!imageUrl.startsWith('http')) {
                        fullImageUrl = window.location.origin + imageUrl;
                    }
                    const viewBtn = document.createElement('a');
                    viewBtn.href = fullImageUrl;
                    viewBtn.target = "_blank";
                    viewBtn.innerHTML = 'ğŸ” ç”»åƒã‚’æ‹¡å¤§';
                    viewBtn.className = 'block text-left text-sm text-gray-700 px-3 py-2 hover:bg-gray-100 rounded text-decoration-none';
                    viewBtn.onclick = function (e) {
                        e.stopPropagation(); // ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‰ã˜ãªã„ã‚ˆã†ã«ã™ã‚‹ãªã‚‰ã“ã‚Œã€é–‰ã˜ã‚‹ãªã‚‰æ¶ˆã™
                        // ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‰ã˜ã¦ã‹ã‚‰é·ç§»ã—ãŸã„å ´åˆã¯ä¸‹è¨˜
                        // menuDiv.classList.add('hidden');
                    };
                    menuDiv.appendChild(viewBtn);
                }

                // 2. [è‡ªåˆ†ã®ã¿] å‰Šé™¤ãƒœã‚¿ãƒ³
                if (isMe && msgId) {
                    const delBtn = document.createElement('button');
                    delBtn.innerHTML = 'ğŸ—‘ï¸ å‰Šé™¤ã™ã‚‹';
                    delBtn.className = 'block w-full text-left text-sm text-red-600 px-3 py-2 hover:bg-red-50 rounded';
                    delBtn.onclick = function (e) {
                        e.stopPropagation();
                        if (confirm('æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                            deleteMessage(msgId);
                        }
                    };
                    menuDiv.appendChild(delBtn);
                }

                bubbleContainer.appendChild(menuDiv);

                // --- ã‚¿ãƒƒãƒ—ã§ãƒ¡ãƒ‹ãƒ¥ãƒ¼è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ ---
                contentP.onclick = function (e) {
                    // ä»–ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‰ã˜ã‚‹
                    document.querySelectorAll('.chat-menu-open').forEach(el => {
                        if (el !== menuDiv) el.classList.add('hidden');
                    });

                    if (menuDiv.classList.contains('hidden')) {
                        menuDiv.classList.remove('hidden');
                        menuDiv.classList.add('chat-menu-open');
                    } else {
                        menuDiv.classList.add('hidden');
                        menuDiv.classList.remove('chat-menu-open');
                    }
                    e.stopPropagation();
                };

                // ç”»é¢å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
                document.addEventListener('click', function () {
                    if (!menuDiv.classList.contains('hidden')) {
                        menuDiv.classList.add('hidden');
                        menuDiv.classList.remove('chat-menu-open');
                    }
                });
            }

            messageDiv.appendChild(senderP);
            messageDiv.appendChild(bubbleContainer);
            chatLog.appendChild(messageDiv);

            chatLog.scrollTop = chatLog.scrollHeight;
        }

    </script>
{% endblock %}
