{% extends "base.html" %}

{% block title %}安否確認・支援要請{% endblock %}
{% block header_title %}安否確認・支援要請{% endblock %}

{% block content %}
<div class="space-y-8">

    {# messagesフレームワークで送信されたメッセージを表示 #}
    {% if messages %}
    <div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded-lg relative" role="alert">
        {% for message in messages %}
        <span class="block sm:inline">{{ message }}</span>
        {% endfor %}
    </div>
    {% endif %}

    <!-- 自分の現在の安否状況 -->
    <div class="bg-blue-50 p-6 rounded-xl shadow-md border border-blue-300">
        <h3 class="text-xl font-bold text-blue-800 mb-2">あなたの現在の状況</h3>
        {% if my_status %}
            <p class="text-lg">
                状態: <span class="font-semibold
                    {% if my_status.status == 'safe' %}text-green-600{% elif my_status.status == 'help' %}text-red-600{% else %}text-gray-600{% endif %}">
                    {{ my_status.get_status_display }}
                </span>
            </p>
            {% if my_status.message %}
            <p class="text-gray-700 mt-2">メッセージ: {{ my_status.message }}</p>
            {% endif %}
            <p class="text-xs text-gray-500 mt-2">最終更新: {{ my_status.last_updated|date:"Y/m/d H:i" }}</p>
        {% else %}
            <p class="text-gray-700">まだ安否が報告されていません。</p>
        {% endif %}
    </div>

    <!-- 1. 安否報告フォーム -->
    <div class="bg-white p-6 rounded-xl shadow-lg">
        <h3 class="text-xl font-bold text-blue-700 mb-4">【あなたの安否状況を報告】</h3>
        <form method="post">
            {% csrf_token %}
            {{ safety_form.as_p }} {# as_pを使うと<p>タグで各項目を囲んでくれる #}
            <button type="submit" name="submit_safety" class="w-full mt-4 bg-blue-600 text-white p-3 rounded-lg hover:bg-blue-700 font-semibold">
                安否を報告・更新する
            </button>
        </form>
    </div>

    <!-- 2. 構造化された支援要請フォーム -->
    <div class="bg-red-50 p-6 rounded-xl shadow-lg border border-red-400">
        <h3 class="text-xl font-bold text-red-700 mb-4">【支援を要請する】</h3>
        <form method="post">
            {% csrf_token %}
            {{ support_form.as_p }}
            <button type="submit" name="submit_support" class="w-full mt-4 bg-red-600 text-white p-3 rounded-lg hover:bg-red-700 font-semibold">
                支援要請を送信
            </button>
        </form>
    </div>

    <!-- 3. 安否確認リスト/支援要請一覧 -->
    <div class="bg-white p-6 rounded-xl shadow-lg">
        <h3 class="text-lg font-semibold mb-2 text-blue-700">他のユーザーの安否状況</h3>
        <ul class="list-disc pl-5 text-gray-700 space-y-2">
            {% for status in safety_list %}
            <li>{{ status.user.username }}：{{ status.get_status_display }} <span class="text-sm text-gray-500">({{ status.last_updated|date:"Y/m/d H:i" }})</span></li>
            {% empty %}
            <li>他のユーザーの安否情報はありません。</li>
            {% endfor %}
        </ul>
    </div>
    <div class="bg-white p-6 rounded-xl shadow-lg">
        <h3 class="text-lg font-semibold mb-2 text-red-700">支援要請一覧 (未対応)</h3>
        <ul class="list-disc pl-5 text-gray-700 space-y-2">
            {% for req in request_list %}
            <li>{{ req.requester.username }}：{{ req.get_category_display }} (優先度: {{ req.get_priority_display }})</li>
            {% empty %}
            <li>現在、未対応の支援要請はありません。</li>
            {% endfor %}
        </ul>
    </div>
</div>
{% endblock %}