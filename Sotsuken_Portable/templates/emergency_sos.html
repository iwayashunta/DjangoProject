{% extends "base.html" %}

{% block title %}緊急SOS発信{% endblock %}
{% block header_title %}緊急SOS発信{% endblock %}

{% block content %}
    <div class="flex flex-col items-center justify-center h-full text-center">

        {# エラーメッセージがあれば表示 #}
        {% if messages %}
            <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg relative mb-6" role="alert">
                {% for message in messages %}
                    <span class="block sm:inline">{{ message }}</span>
                {% endfor %}
            </div>
        {% endif %}

        <form id="sos-form" method="post" onsubmit="return disableButton(this)">
            {% csrf_token %}
            {# 位置情報を裏で送信するための隠しフィールド #}
            <input type="hidden" name="latitude" id="latitude">
            <input type="hidden" name="longitude" id="longitude">

            {# SOS発信ボタン #}
            <button type="submit" id="sos-button"
                    class="bg-white p-10 rounded-full shadow-2xl w-56 h-56 flex items-center justify-center border-8 border-red-500 transform hover:scale-105 transition-transform cursor-pointer">
                <h2 class="text-3xl font-extrabold text-red-600">SOS発信</h2>
            </button>
        </form>

        <p id="status-message" class="mt-8 text-lg text-gray-600 font-medium">
            ボタンを押すと、現在地の位置情報が救助チームに送信されます。
        </p>
    </div>

    {# --- ここからJavaScript --- #}
    <script>
        const sosForm = document.getElementById('sos-form');
        const sosButton = document.getElementById('sos-button');
        const latitudeInput = document.getElementById('latitude');
        const longitudeInput = document.getElementById('longitude');
        const statusMessage = document.getElementById('status-message');

        sosForm.addEventListener('submit', function (event) {
            // 1. フォームの通常の送信を一旦停止
            event.preventDefault();

            // 2. ボタンを無効化
            sosButton.disabled = true;
            statusMessage.textContent = '位置情報を取得しています...';
            statusMessage.classList.remove('text-gray-600');
            statusMessage.classList.add('text-blue-600');

            // --- 位置情報取得処理 ---
            if (!navigator.geolocation) {
                // 非対応の場合 -> デモ送信へ
                handleGeoError("Geolocation not supported");
            } else {
                navigator.geolocation.getCurrentPosition(
                    // 成功時
                    function (position) {
                        statusMessage.textContent = '位置情報を取得しました。SOSを発信します...';
                        latitudeInput.value = position.coords.latitude;
                        longitudeInput.value = position.coords.longitude;
                        sosForm.submit();
                    },
                    // 失敗時 -> デモ送信へ
                    function (error) {
                        handleGeoError(error);
                    },
                    // オプション (タイムアウト設定など)
                    { timeout: 10000 }
                );
            }
        });

        // ★追加: エラー時の救済処置（デモ送信）
        function handleGeoError(error) {
            console.warn("位置情報エラー:", error);

            // ユーザーへの通知（本番っぽく見せるならアラートは出さなくても良いが、デモだと分かるように出す）
            alert("【デモモード】位置情報が取得できないため、\n自動的にデモ用座標を設定してSOSを発信します。");

            statusMessage.textContent = 'デモ用座標でSOSを発信します...';

            // 固定値を入れる
            latitudeInput.value = 34.380780;
            longitudeInput.value = 132.468517;

            // そのまま送信！
            sosForm.submit();
        }
    </script>
{% endblock %}