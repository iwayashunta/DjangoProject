{% extends 'base.html' %}
{% load static %}

{% block title %}QRコードスキャナー{% endblock %}
{% block header_title %}QRコードスキャナー{% endblock %}

{% block content %}
<div class="p-4 md:p-8 max-w-lg mx-auto">
    <div class="bg-white p-6 rounded-xl shadow-lg text-center">
        <h3 class="text-lg font-semibold mb-4">QRコードを読み取る</h3>
        
        <div id="scanner-ui-container">
            <p id="scan-instruction" class="text-gray-600 mb-4">下のボタンを押して、カメラでQRコードをスキャンしてください。</p>
            <button id="start-qr-scan-button" class="w-full bg-blue-500 text-white p-3 rounded-lg hover:bg-blue-600 transition-colors font-semibold">
                カメラを起動
            </button>
        </div>

        <!-- スキャナーが表示されるエリア (普段は非表示) -->
        <div id="qr-scanner-container" class="mt-4 border-4 rounded-lg overflow-hidden" style="display: none;">
            <div id="qr-reader" style="width: 100%;"></div>
        </div>
        
        <!-- スキャン停止ボタン (普段は非表示) -->
        <button id="stop-qr-scan-button" class="w-full bg-red-500 text-white p-2 rounded-lg hover:bg-red-600 transition-colors font-semibold mt-4" style="display: none;">
            スキャンを停止
        </button>
    </div>
</div>
{% endblock %}

{% block body_extra %}
<!-- QRコード読み取りライブラリ (html5-qrcode) -->
<script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const startButton = document.getElementById('start-qr-scan-button');
    const stopButton = document.getElementById('stop-qr-scan-button');
    const scannerContainer = document.getElementById('qr-scanner-container');
    const scannerUiContainer = document.getElementById('scanner-ui-container');

    const html5QrCode = new Html5Qrcode("qr-reader");

    // ★★★ スキャン成功時の処理 ★★★
    const onScanSuccess = (decodedText, decodedResult) => {
        stopScan(); // スキャンを停止
        
        try {
            const scannedData = JSON.parse(decodedText);

            // QRコードの 'type' キーの値を見て、処理を振り分ける
            if (scannedData.type === 'user_status') {
                // --- 安否情報QRコードの場合 ---
                const message = `安否情報を読み取りました:\n` +
                                `------------------------\n` +
                                `氏名: ${scannedData.full_name}\n` +
                                `状況: ${scannedData.safety_status}\n` +
                                `更新: ${scannedData.last_updated || 'N/A'}`;
                alert(message);
                // ここでDM画面へのリンクを表示するなどの拡張が可能

            } else if (scannedData.type === 'group_invite') {
                // --- グループ招待QRコードの場合 ---
                const confirmJoin = confirm(
                    `グループ招待を読み取りました:\n` +
                    `------------------------\n` +
                    `グループ名: 「${scannedData.group_name}」\n\n` +
                    `このグループに参加しますか？`
                );

                if (confirmJoin) {
                    // 「OK」が押されたら、グループ参加処理を行うURLに移動する
                    // (※このURLとビューは別途作成する必要があります)
                    alert(`「${scannedData.group_name}」への参加処理を実行します。（ダミー）`);
                    // window.location.href = `/groups/join-by-code/${scannedData.invitation_code}/`;
                }

            } else {
                // --- 知らないタイプのQRコードの場合 ---
                alert(`非対応のQRコードです。\nデータ: ${JSON.stringify(scannedData)}`);
            }
        
        } catch (e) {
            // JSONではない、ただのURLやテキストの場合
            alert(`読み取ったデータ:\n${decodedText}`);
        }
    };

    // スキャンを開始する処理
    function startScan() {
        // UIの表示を切り替え
        scannerContainer.style.display = 'block';
        stopButton.style.display = 'block';
        startButton.style.display = 'none';

        // カメラを起動してスキャンを開始
        html5QrCode.start(
            { facingMode: "environment" }, // 背面カメラを使用
            {
                fps: 10, // 1秒あたりのスキャン回数
                qrbox: { width: 250, height: 250 } // スキャン範囲のUIサイズ
            },
            onScanSuccess,
            onScanFailure
        ).catch(err => {
            alert('カメラの起動に失敗しました。カメラのアクセスを許可してください。');
            console.error("Unable to start scanning.", err);
            stopScan(); // 失敗時もUIを元に戻す
        });
    }

    // スキャンを停止する処理
    function stopScan() {
        html5QrCode.stop().then(ignore => {
            // UIの表示を元に戻す
            scannerContainer.style.display = 'none';
            stopButton.style.display = 'none';
            startButton.style.display = 'block';
        }).catch(err => {
            console.error("Unable to stop scanning.", err);
        });
    }

    startButton.addEventListener('click', startScan);
    stopButton.addEventListener('click', stopScan);
});
</script>
{% endblock %}