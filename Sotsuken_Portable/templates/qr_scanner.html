{% extends 'base.html' %}
{% load static %}

{% block title %}QRã‚³ãƒ¼ãƒ‰ã‚¹ã‚­ãƒ£ãƒŠãƒ¼{% endblock %}
{% block header_title %}QRã‚³ãƒ¼ãƒ‰ã‚¹ã‚­ãƒ£ãƒŠãƒ¼{% endblock %}

{% block content %}
<div class="p-4 md:p-8 max-w-lg mx-auto">
    <div class="bg-white p-6 rounded-xl shadow-lg text-center">
        <h3 class="text-lg font-semibold mb-4">QRã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿å–ã‚‹</h3>
        
        <!-- åˆæœŸUI -->
        <div id="scanner-ui-container">
            <p class="text-gray-600 mb-4">ä¸‹ã®ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ã€<br>ã‚«ãƒ¡ãƒ©ã§QRã‚³ãƒ¼ãƒ‰ã‚’ã‚¹ã‚­ãƒ£ãƒ³ã—ã¦ãã ã•ã„ã€‚</p>
            <button id="start-qr-scan-button" class="w-full bg-blue-500 text-white p-3 rounded-lg hover:bg-blue-600 transition-colors font-semibold shadow-md">
                ğŸ“· ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•
            </button>
        </div>

        <!-- ã‚¹ã‚­ãƒ£ãƒŠãƒ¼ã‚¨ãƒªã‚¢ (åˆæœŸéè¡¨ç¤º) -->
        <div id="qr-scanner-container" class="mt-4 rounded-lg overflow-hidden border-4 border-gray-300 hidden">
            <div id="qr-reader" style="width: 100%;"></div>
        </div>

        <!-- åœæ­¢ãƒœã‚¿ãƒ³ (åˆæœŸéè¡¨ç¤º) -->
        <button id="stop-qr-scan-button" class="w-full bg-red-500 text-white p-2 rounded-lg hover:bg-red-600 transition-colors font-semibold mt-4 shadow-md hidden">
            ã‚¹ã‚­ãƒ£ãƒ³ã‚’åœæ­¢
        </button>

        <!-- â˜…â˜…â˜… çµæœè¡¨ç¤ºã‚¨ãƒªã‚¢ (åˆæœŸéè¡¨ç¤º) â˜…â˜…â˜… -->
        <div id="scan-result-container" class="mt-6 hidden animate-fade-in-up">
            <!-- ã“ã“ã«JSã§çµæœã‚’æµã—è¾¼ã‚€ -->
        </div>
    </div>

    <div class="text-center mt-6">
        <a href="{% url 'Sotsuken_Portable:user_menu' %}" class="text-gray-500 hover:underline">æˆ»ã‚‹</a>
    </div>
</div>
{% endblock %}



{% block body_extra %}
<!-- QRã‚³ãƒ¼ãƒ‰èª­ã¿å–ã‚Šãƒ©ã‚¤ãƒ–ãƒ©ãƒª (html5-qrcode) -->
<script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const startButton = document.getElementById('start-qr-scan-button');
    const stopButton = document.getElementById('stop-qr-scan-button');
    const scannerContainer = document.getElementById('qr-scanner-container');
    const uiContainer = document.getElementById('scanner-ui-container');

    // â˜…è¿½åŠ : çµæœè¡¨ç¤ºã‚³ãƒ³ãƒ†ãƒŠ
    const resultContainer = document.getElementById('scan-result-container');

    const html5QrCode = new Html5Qrcode("qr-reader");

    // XSSå¯¾ç­–ç”¨ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—é–¢æ•°
    function escapeHtml(text) {
        if (!text) return "";
        return text.replace(/[&<>"']/g, function(m) {
            return { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' }[m];
        });
    }

    // â˜…â˜…â˜… ã‚¹ã‚­ãƒ£ãƒ³æˆåŠŸæ™‚ã®å‡¦ç† (ä¿®æ­£ç‰ˆ) â˜…â˜…â˜…
    const onScanSuccess = (decodedText, decodedResult) => {
        // ã‚¹ã‚­ãƒ£ãƒ³ã‚’æ­¢ã‚ã‚‹
        stopScan();

        // UIã‚’çµæœè¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆ
        uiContainer.style.display = 'none'; // ã€Œã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•ã€ãƒœã‚¿ãƒ³ã‚’æ¶ˆã™
        resultContainer.classList.remove('hidden'); // çµæœã‚¨ãƒªã‚¢ã‚’è¡¨ç¤º

        // 1. ã‚°ãƒ«ãƒ¼ãƒ—æ‹›å¾…URLã®å ´åˆ
        if (decodedText.includes('/groups/join-by-code/')) {
            resultContainer.innerHTML = `
                <div class="bg-blue-50 border-l-4 border-blue-500 p-4 text-left">
                    <p class="font-bold text-blue-700 mb-2">ã‚°ãƒ«ãƒ¼ãƒ—æ‹›å¾…QRã‚’èª­ã¿å–ã‚Šã¾ã—ãŸ</p>
                    <p class="text-sm text-gray-600 mb-4">ã“ã®ã‚°ãƒ«ãƒ¼ãƒ—ã«å‚åŠ ã—ã¾ã™ã‹ï¼Ÿ</p>
                    <div class="flex gap-2">
                        <a href="${decodedText}" class="bg-blue-600 text-white px-4 py-2 rounded shadow hover:bg-blue-700 flex-1 text-center font-bold">å‚åŠ ã™ã‚‹</a>
                        <button onclick="location.reload()" class="bg-gray-300 text-gray-700 px-4 py-2 rounded hover:bg-gray-400">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    </div>
                </div>
            `;
            return;
        }

        // 2. JSONãƒ‡ãƒ¼ã‚¿ (å®‰å¦æƒ…å ±) ã®å ´åˆ
        try {
            const data = JSON.parse(decodedText);
            if (data.t === 'us') { // t: 'us' (user_status)

                // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã«å¿œã˜ãŸè‰²ã¨ãƒ†ã‚­ã‚¹ãƒˆ
                let statusHtml = "";
                if (data.ss === 'safe') {
                    statusHtml = '<span class="text-green-600 font-bold text-xl">âœ… ç„¡äº‹</span>';
                } else if (data.ss === 'help') {
                    statusHtml = '<span class="text-red-600 font-bold text-xl animate-pulse">ğŸ†˜ è¦æ•‘åŠ©</span>';
                } else {
                    statusHtml = '<span class="text-gray-500 font-bold text-xl">â“ æœªç¢ºèª</span>';
                }

                // æ—¥æ™‚ã®æ•´å½¢ (ä¾‹: 202512251030 -> 12/25 10:30)
                let dateStr = "ä¸æ˜";
                if (data.lu && data.lu.length >= 12) {
                    const Y = data.lu.substring(0,4);
                    const M = data.lu.substring(4,6);
                    const D = data.lu.substring(6,8);
                    const h = data.lu.substring(8,10);
                    const m = data.lu.substring(10,12);
                    dateStr = `${Y}/${M}/${D} ${h}:${m}`;
                }

                resultContainer.innerHTML = `
                    <div class="bg-white border-2 border-gray-200 rounded-xl p-6 shadow-md">
                        <h4 class="text-gray-500 text-sm mb-1">å®‰å¦æƒ…å ±</h4>
                        <h2 class="text-2xl font-bold text-gray-800 mb-4">${escapeHtml(data.fn)} ã•ã‚“</h2>

                        <div class="bg-gray-50 p-4 rounded-lg mb-4">
                            <p class="text-sm text-gray-500 mb-1">ç¾åœ¨ã®çŠ¶æ³</p>
                            ${statusHtml}
                        </div>

                        <p class="text-xs text-gray-400 text-right">æœ€çµ‚æ›´æ–°: ${dateStr}</p>

                        <button onclick="location.reload()" class="mt-6 w-full bg-blue-500 text-white py-2 rounded-lg font-bold hover:bg-blue-600">
                            ç¶šã‘ã¦ã‚¹ã‚­ãƒ£ãƒ³ã™ã‚‹
                        </button>
                    </div>
                `;

            } else {
                throw new Error("Unknown JSON format");
            }
        } catch (e) {
            // 3. ãã®ä»–ã®ãƒ†ã‚­ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿
            resultContainer.innerHTML = `
                <div class="bg-gray-100 p-4 rounded text-left break-all">
                    <p class="font-bold text-gray-700 mb-2">ãƒ†ã‚­ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿å–ã‚Šã¾ã—ãŸ</p>
                    <p class="text-gray-800">${escapeHtml(decodedText)}</p>
                    <button onclick="location.reload()" class="mt-4 w-full bg-gray-300 text-gray-800 py-2 rounded hover:bg-gray-400">
                        æˆ»ã‚‹
                    </button>
                </div>
            `;
        }
    };

    const onScanFailure = (error) => {
        // èª­ã¿å–ã‚Šå¤±æ•—æ™‚ã¯ä½•ã‚‚ã—ãªã„
    };

    // --- ä»¥ä¸‹ã€é–‹å§‹ãƒ»åœæ­¢å‡¦ç† (å¤‰æ›´ãªã—ã€ã‚¯ãƒ©ã‚¹æ“ä½œã ã‘å¾®ä¿®æ­£) ---
    function startScan() {
        scannerContainer.classList.remove('hidden'); // style.display = 'block' ã®ä»£ã‚ã‚Š
        stopButton.classList.remove('hidden');
        uiContainer.style.display = 'none';
        resultContainer.classList.add('hidden'); // çµæœã‚’éš ã™

        html5QrCode.start(
            { facingMode: "environment" },
            { fps: 10, qrbox: { width: 250, height: 250 } },
            onScanSuccess,
            onScanFailure
        ).catch(err => {
            alert('ã‚«ãƒ¡ãƒ©ã®èµ·å‹•ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
            stopScan();
        });
    }

    function stopScan() {
        html5QrCode.stop().then(() => {
            scannerContainer.classList.add('hidden');
            stopButton.classList.add('hidden');
            // çµæœãŒå‡ºã¦ã„ãªã‘ã‚Œã°ã€åˆæœŸUIã«æˆ»ã™
            if (resultContainer.classList.contains('hidden')) {
                uiContainer.style.display = 'block';
            }
        }).catch(console.error);
    }

    startButton.addEventListener('click', startScan);
    stopButton.addEventListener('click', stopScan);
});
</script>
{% endblock %}