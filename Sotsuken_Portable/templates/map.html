{% extends "base.html" %}

{% block title %}マップ{% endblock %}
{% block header_title %}マップ{% endblock %}

{% block head_extra %}
    <style>
        #map { height: 70vh; }
    </style>
{% endblock %}

{% block content %}
    <div id="map" class="w-full rounded-lg shadow-lg"></div>

    <script>
        const sheltersData = JSON.parse('{{ shelters_json|safe }}');
        const apiKey = '{{ google_maps_api_key }}';

        let map;
        let directionsService;
        let directionsRenderer;

        // --- リアルタイム更新で変更する変数 ---
        let userLocationMarker; // 現在地マーカーを保持する変数
        let locationSocket;     // WebSocketインスタンスを保持する変数

        function initMap() {
            const mapOptions = {
                center: { lat: 34.385, lng: 132.455 }, // 広島市役所あたり
                zoom: 12,
            };
            map = new google.maps.Map(document.getElementById("map"), mapOptions);

            directionsService = new google.maps.DirectionsService();
            directionsRenderer = new google.maps.DirectionsRenderer();
            directionsRenderer.setMap(map);

            // 避難所のマーカーを設置 (既存のまま)
            sheltersData.forEach(function(shelter) {
                const marker = new google.maps.Marker({
                    position: { lat: shelter.lat, lng: shelter.lng },
                    map: map,
                    title: shelter.name,
                });
                const contentString = `<b>${shelter.name}</b><br>` +
                                      `住所: ${shelter.address}<br>` +
                                      `収容状況: ${shelter.occupancy} / ${shelter.capacity}<br>` +
                                      `<button onclick="calculateAndDisplayRoute({lat: ${shelter.lat}, lng: ${shelter.lng}})">ここへのルートを表示</button>`;
                const infowindow = new google.maps.InfoWindow({ content: contentString });
                marker.addListener("click", () => { infowindow.open(map, marker); });
            });

            // ★ 新しく追加: リアルタイム位置情報更新を開始
            startRealtimeLocation();
        }

        // --- ★ ここからWebSocketと位置情報監視のロジック ---
        function startRealtimeLocation() {
            const DEMO_LAT = 34.380780;
            const DEMO_LON = 132.468517;

            if (!navigator.geolocation) {
                handleGeoError("Geolocation not supported", DEMO_LAT, DEMO_LON);
                return;
            }

            const wsProtocol = window.location.protocol === 'https:' ? 'wss://' : 'ws://';
            const wsUrl = wsProtocol + window.location.host + '/ws/location/';
            locationSocket = new WebSocket(wsUrl);

            locationSocket.onopen = () => console.log("Location WS connected.");
            locationSocket.onclose = () => console.error('Location WS closed.');
            locationSocket.onerror = (err) => console.error('WS error:', err);

            navigator.geolocation.watchPosition(
                (position) => {
                    const userPos = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude,
                    };
                    if (locationSocket.readyState === WebSocket.OPEN) {
                        locationSocket.send(JSON.stringify(userPos));
                    }
                    updateUserMarker(userPos);
                },
                // ★修正: エラー時はデモモードへ
                (err) => {
                    handleGeoError(err, DEMO_LAT, DEMO_LON);
                },
                { enableHighAccuracy: true, timeout: 10000 }
            );
        }

        function handleGeoError(err, lat, lon) {
            console.warn("位置情報取得エラー (デモモード):", err);

            // デモ位置でマーカー更新
            const userPos = { lat: lat, lng: lon };
            updateUserMarker(userPos);

            // WebSocket送信 (接続できていれば)
            if (locationSocket && locationSocket.readyState === WebSocket.OPEN) {
                locationSocket.send(JSON.stringify(userPos));
            }
        }

        function updateUserMarker(position) {
            if (!userLocationMarker) {
                // 最初の位置情報取得時にマーカーを作成
                userLocationMarker = new google.maps.Marker({
                    position: position,
                    map: map,
                    title: "あなたの現在地",
                    icon: {
                        path: google.maps.SymbolPath.CIRCLE,
                        scale: 8,
                        fillColor: "#4285F4",
                        fillOpacity: 1,
                        strokeWeight: 2,
                        strokeColor: "#ffffff",
                    },
                });
                // 地図の中心を現在地に移動
                map.setCenter(position);
                map.setZoom(15);
            } else {
                // 既存のマーカーの位置を更新
                userLocationMarker.setPosition(position);
            }
        }
        // --- ★ ここまでが追加・変更されたロジック ---


        // ルートを計算して表示する関数 (★ 修正)
        function calculateAndDisplayRoute(destination) {
            // userLocation変数ではなく、マーカーの現在位置を始点にする
            if (!userLocationMarker) {
                alert("現在地が取得できていません。");
                return;
            }
            const origin = userLocationMarker.getPosition().toJSON();

            directionsService.route({
                origin: origin,
                destination: destination,
                travelMode: 'WALKING'
            }, (response, status) => {
                if (status === 'OK') {
                    directionsRenderer.setDirections(response);
                } else {
                    window.alert('ルート検索に失敗しました: ' + status);
                }
            });
        }
    </script>
    
    <script async defer
        src="https://maps.googleapis.com/maps/api/js?key={{ google_maps_api_key }}&callback=initMap">
    </script>
{% endblock %}