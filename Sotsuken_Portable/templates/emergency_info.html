{% extends "base.html" %}

{% block title %}緊急情報{% endblock %}
{% block header_title %}緊急情報{% endblock %}

{% block content %}
    <div class="space-y-8">

        <!-- ★★★ 追加: 管理者からの公式アナウンス（最優先） ★★★ -->
        {% if official_alerts %}
            <div class="bg-yellow-50 p-6 rounded-xl shadow-lg border-l-8 border-yellow-500">
                <h3 class="text-xl font-bold mb-4 text-yellow-800 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24"
                         stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                              d="M11 5.882V19.24a1.76 1.76 0 01-3.417.592l-2.147-6.15M18 13a3 3 0 100-6M5.436 13.683A4.001 4.001 0 017 6h1.832c4.1 0 7.625-1.234 9.168-3v14c-1.543-1.766-5.067-3-9.168-3H7a3.988 3.988 0 01-1.564-.317z"/>
                    </svg>
                    対策本部からのお知らせ
                </h3>

                <div class="space-y-4">
                    {% for alert in official_alerts %}
                        <div class="bg-white p-4 rounded-lg border border-yellow-200 shadow-sm">
                            <div class="flex justify-between items-start mb-2">
                                <!-- 重要度バッジ -->
                                {% if alert.severity == 'emergency' %}
                                    <span class="bg-red-600 text-white text-xs font-bold px-2 py-1 rounded animate-pulse">緊急</span>
                                {% elif alert.severity == 'warning' %}
                                    <span class="bg-orange-500 text-white text-xs font-bold px-2 py-1 rounded">重要</span>
                                {% else %}
                                    <span class="bg-blue-500 text-white text-xs font-bold px-2 py-1 rounded">情報</span>
                                {% endif %}

                                <span class="text-xs text-gray-500">{{ alert.published_at|date:"Y/m/d H:i" }}</span>
                            </div>

                            <h4 class="font-bold text-lg text-gray-900 mb-2">{{ alert.title }}</h4>
                            <p class="text-sm text-gray-800 whitespace-pre-line">{{ alert.content }}</p>
                        </div>
                    {% endfor %}
                </div>
            </div>
        {% endif %}

        <!-- 1. 行政の発信 -->
        <div class="bg-white p-6 rounded-xl shadow-lg">
            <h3 class="text-xl font-semibold mb-4 text-red-600">
                行政の発信 <span id="area-label" class="text-sm text-gray-500 ml-2">(位置情報取得中...)</span>
            </h3>

            <!-- ここにJSでデータを流し込む -->
            <div id="alert-container"
                 class="bg-red-50 p-4 rounded-lg h-48 overflow-y-auto border border-red-300 space-y-3">
                <p class="text-gray-500 text-center py-4">読み込み中...</p>
            </div>
        </div>

        <!-- 2. 避難場所空き情報 -->
        <div class="bg-white p-6 rounded-xl shadow-lg">
            <h3 class="text-xl font-semibold mb-4 text-blue-600">避難場所空き情報</h3>
            <ul class="list-disc pl-5 text-gray-700 space-y-2">
                {% for shelter in shelters %}
                    <li>
                        {{ shelter.name }}:
                        {% if shelter.current_occupancy >= shelter.max_capacity %}
                            <span class="text-red-500 font-bold">満室</span>
                        {% else %}
                            <span class="text-green-500 font-bold">空きあり</span>
                        {% endif %}
                        (現在 {{ shelter.current_occupancy }} / 定員 {{ shelter.max_capacity }})
                    </li>
                {% empty %}
                    <li>避難所情報が登録されていません。</li>
                {% endfor %}
            </ul>
        </div>

        <!-- 3. 静的な情報 (ハザードマップ、連絡先) -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="bg-white p-6 rounded-xl shadow-lg text-center">
                <h3 class="text-lg font-semibold mb-4">周辺ハザードマップ</h3>
                <p class="text-sm text-gray-600 mb-4">現在地周辺のリスク情報を確認します。</p>

                <!-- デフォルトのリンク（GPSオフの場合用） -->
                <a id="hazard-map-link"
                   href="https://disaportal.gsi.go.jp/"
                   target="_blank"
                   class="w-full bg-blue-600 text-white p-3 rounded-lg hover:bg-blue-700 font-semibold inline-flex justify-center items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                         stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                              d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                              d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                    </svg>
                    現在地のハザードマップを見る
                </a>
                <p id="gps-status" class="text-xs text-gray-400 mt-2">位置情報を取得中...</p>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-lg">
                <h3 class="text-lg font-semibold mb-4">防災用連絡先</h3>
                <ul class="list-disc pl-5 text-gray-700">
                    <li>災害対策本部: 090-XXXX-XXXX</li>
                    <li>消防・救急: 119</li>
                </ul>
            </div>

            <!-- 炊き出し・物資配布情報 -->
            <div class="bg-white p-6 rounded-xl shadow-lg">
                <h3 class="text-xl font-semibold mb-4 text-orange-600">炊き出し・物資配布</h3>

                <!-- ★★★ あなたの避難所の情報（最優先表示） ★★★ -->
                {% if my_distributions %}
                    <div class="mb-6">
                        <h4 class="font-bold text-lg text-green-700 mb-2 flex items-center gap-2">
                <span class="bg-green-100 text-green-800 px-2 py-1 rounded text-sm border border-green-300">
                    現在の避難所 ({{ user.last_known_location }})
                </span>
                            の情報
                        </h4>
                        <div class="grid grid-cols-1 gap-4 border-l-4 border-green-500 pl-4 bg-green-50 p-4 rounded-r-lg">
                            {% for dist in my_distributions %}
                                <div class="border border-orange-200 rounded-lg p-4 {% if dist.status == 'active' %}bg-orange-50{% endif %}">
                                    <div class="flex justify-between items-start mb-2">
                        <span class="text-xs font-bold px-2 py-1 rounded
                            {% if dist.status == 'active' %}bg-red-500 text-white animate-pulse
                            {% else %}bg-blue-500 text-white{% endif %}">
                            {{ dist.get_status_display }}
                        </span>
                                        <span class="text-xs text-gray-500">{{ dist.get_info_type_display }}</span>
                                    </div>

                                    <h4 class="font-bold text-lg text-gray-800 mb-1">{{ dist.title }}</h4>

                                    <p class="text-sm text-gray-600 mb-2">
                                        <span class="font-semibold">場所:</span>
                                        {% if dist.shelter %}{{ dist.shelter.name }}{% else %}
                                            {{ dist.location_name }}{% endif %}
                                    </p>

                                    {% if dist.start_time %}
                                        <p class="text-xs text-gray-500">
                                            開始: {{ dist.start_time|date:"m/d H:i" }} ~
                                        </p>
                                    {% endif %}

                                    {% if dist.description %}
                                        <p class="text-sm text-gray-700 mt-2 pt-2 border-t border-orange-100">
                                            {{ dist.description|linebreaksbr }}
                                        </p>
                                    {% endif %}
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                {% endif %}

                <!-- ★★★ その他の情報 ★★★ -->
                <h4 class="font-bold text-gray-600 mb-2">その他の地域の情報</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    {% for dist in other_distributions %}
                        <div class="border border-orange-200 rounded-lg p-4 {% if dist.status == 'active' %}bg-orange-50{% endif %}">
                            <div class="flex justify-between items-start mb-2">
                        <span class="text-xs font-bold px-2 py-1 rounded
                            {% if dist.status == 'active' %}bg-red-500 text-white animate-pulse
                            {% else %}bg-blue-500 text-white{% endif %}">
                            {{ dist.get_status_display }}
                        </span>
                                <span class="text-xs text-gray-500">{{ dist.get_info_type_display }}</span>
                            </div>

                            <h4 class="font-bold text-lg text-gray-800 mb-1">{{ dist.title }}</h4>

                            <p class="text-sm text-gray-600 mb-2">
                                <span class="font-semibold">場所:</span>
                                {% if dist.shelter %}{{ dist.shelter.name }}{% else %}
                                    {{ dist.location_name }}{% endif %}
                            </p>

                            {% if dist.start_time %}
                                <p class="text-xs text-gray-500">
                                    開始: {{ dist.start_time|date:"m/d H:i" }} ~
                                </p>
                            {% endif %}

                            {% if dist.description %}
                                <p class="text-sm text-gray-700 mt-2 pt-2 border-t border-orange-100">
                                    {{ dist.description|linebreaksbr }}
                                </p>
                            {% endif %}
                        </div>
                    {% empty %}
                        <p class="text-gray-500　whitespace-nowrap">現在、配布情報はありません。</p>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const linkElement = document.getElementById('hazard-map-link');
            const statusElement = document.getElementById('gps-status');

            if ("geolocation" in navigator) {
                navigator.geolocation.getCurrentPosition(
                    function (position) {
                        const lat = position.coords.latitude;
                        const lon = position.coords.longitude;

                        // 国土交通省「重ねるハザードマップ」へのダイレクトリンクを作成
                        // ズームレベル(zl)は15くらいが見やすい
                        const mapUrl = `https://disaportal.gsi.go.jp/maps/?ll=${lat},${lon}&z=15`;

                        linkElement.href = mapUrl;
                        statusElement.textContent = "現在地が設定されました";
                        statusElement.classList.add("text-green-500");
                    },
                    function (error) {
                        console.error("位置情報の取得に失敗:", error);
                        statusElement.textContent = "位置情報を取得できませんでした（標準トップページを開きます）";
                    }
                );
            } else {
                statusElement.textContent = "お使いのブラウザは位置情報に対応していません";
            }
        });

        document.addEventListener('DOMContentLoaded', function () {
            const container = document.getElementById('alert-container');
            const label = document.getElementById('area-label');

            if ("geolocation" in navigator) {
                navigator.geolocation.getCurrentPosition(async function (position) {
                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;

                    try {
                        // APIに問い合わせ
                        const response = await fetch(`/ajax/get-nearby-alerts/?lat=${lat}&lon=${lon}`);
                        const data = await response.json();

                        if (data.status === 'success') {
                            label.textContent = `(${data.area_name} 周辺)`;
                            container.innerHTML = ''; // クリア

                            if (data.alerts.length === 0) {
                                container.innerHTML = '<p class="text-gray-500">現在、有効な警報はありません。</p>';
                            } else {
                                data.alerts.forEach(alert => {
                                    const html = `
                                <div class="border-b pb-2 border-red-200">
                                    <p class="font-bold text-gray-800">[${alert.severity}] ${alert.title}</p>
                                    <p class="text-sm text-gray-700 whitespace-pre-line">${alert.content}</p>
                                    <p class="text-xs text-right text-gray-500">${alert.date}</p>
                                </div>
                            `;
                                    container.insertAdjacentHTML('beforeend', html);
                                });
                            }
                        }
                    } catch (e) {
                        console.error(e);
                        container.innerHTML = '<p class="text-red-500">情報の取得に失敗しました。</p>';
                    }
                }, function (error) {
                    label.textContent = "(位置情報オフ)";
                    container.innerHTML = '<p class="text-gray-500">位置情報を許可すると、周辺の警報を表示します。</p>';
                });
            }
        });
    </script>
{% endblock %}