{% extends "base.html" %}
{% block title %}ãƒãƒ£ãƒƒãƒˆ - {{ other_user.full_name|default:other_user.username }}{% endblock %}
{% block header_title %}{{ other_user.full_name|default:other_user.username }}{% endblock %}

{% block content %}
    <div class="flex flex-col h-[75vh]">
        <div id="chat-log" class="flex-1 bg-white p-4 rounded-t-xl shadow-inner mb-4 overflow-y-auto space-y-4">
            {# éå»ãƒ­ã‚°ã®è¡¨ç¤º (Alpine.jsç‰ˆãƒ¡ãƒ‹ãƒ¥ãƒ¼) #}
            {% for msg in chat_messages %}
                <div id="msg-{{ msg.id }}"
                     class="text-base mb-4 relative group {% if msg.sender == user %}text-right{% endif %}"
                     x-data="{ menuOpen: false }">

                    <p class="font-bold text-sm text-gray-500">{{ msg.sender.full_name|default:msg.sender.username }}</p>

                    <div class="inline-block relative text-left">
                        <!-- å¹ãå‡ºã— (ã‚¯ãƒªãƒƒã‚¯ã§ãƒ¡ãƒ‹ãƒ¥ãƒ¼é–‹é–‰) -->
                        <div @click="menuOpen = !menuOpen"
                             @click.outside="menuOpen = false"
                             class="cursor-pointer {% if msg.sender == user %}bg-blue-500 text-white{% else %}bg-gray-200{% endif %} p-3 rounded-t-xl {% if msg.sender == user %}rounded-bl-xl{% else %}rounded-br-xl{% endif %} inline-block max-w-xs text-left break-words">

                            {% if msg.image %}
                                <!-- â˜…ä¿®æ­£: aã‚¿ã‚°ãªã—ã€‚imgã‚¿ã‚°ã®ã¿ (pointer-events-noneã§ã‚¯ãƒªãƒƒã‚¯é€é) -->
                                <img src="{{ msg.image.url }}"
                                     class="max-w-full h-auto rounded-lg mb-1 pointer-events-none"
                                     style="max-height: 200px;">
                                {% if msg.content %}<br>{% endif %}
                            {% endif %}

                            {{ msg.content|urlize|linebreaksbr }}
                        </div>

                        <!-- â˜…ãƒ¡ãƒ‹ãƒ¥ãƒ¼ (ç”»åƒæ‹¡å¤§ãƒ»å‰Šé™¤) -->
                        <div x-show="menuOpen"
                             x-transition
                             style="display: none;"
                             class="absolute z-20 bg-white shadow-xl border border-gray-200 rounded-lg p-1 min-w-[140px] flex flex-col gap-1 mt-1
                                    {% if msg.sender == user %}right-0{% else %}left-0{% endif %}">

                            {# 1. ç”»åƒæ‹¡å¤§ãƒœã‚¿ãƒ³ #}
                            {% if msg.image %}
                                <a href="{{ msg.image.url }}" target="_blank"
                                   class="block text-left text-sm text-gray-700 px-3 py-2 hover:bg-gray-100 rounded no-underline">
                                    ğŸ” ç”»åƒã‚’æ‹¡å¤§
                                </a>
                            {% endif %}

                            {# 2. å‰Šé™¤ãƒœã‚¿ãƒ³ #}
                            {% if msg.sender == user %}
                                <button onclick="if(confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) deleteMessage({{ msg.id }})"
                                        class="block w-full text-left text-sm text-red-600 px-3 py-2 hover:bg-red-50 rounded">
                                    ğŸ—‘ï¸ å‰Šé™¤ã™ã‚‹
                                </button>
                            {% endif %}
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>

        <!-- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  (å¤‰æ›´ãªã—) -->
        <form id="chat-form" class="flex flex-col gap-2 p-2" autocomplete="off" enctype="multipart/form-data">
            {% csrf_token %}
            <div class="flex items-center gap-2">
                <label class="text-sm text-gray-600 font-bold">æ·»ä»˜ç”»åƒ:</label>
                <input type="file" id="chat-image-input" accept="image/*"
                       class="text-sm text-gray-600 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
            </div>
            <div class="flex w-full items-end">
                <textarea id="chat-message-input" rows="1"
                          class="flex-1 p-3 border border-gray-300 rounded-l-xl focus:outline-none focus:ring-2 focus:ring-blue-500 text-base resize-none overflow-hidden"
                          placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›..."></textarea>
                <button type="submit" id="chat-message-submit"
                        class="bg-blue-600 text-white p-3 rounded-r-xl hover:bg-blue-700 font-semibold whitespace-nowrap h-full">
                    é€ä¿¡
                </button>
            </div>
        </form>
    </div>

    {{ other_user.id|json_script:"other-user-id" }}
    {{ user.full_name|default:user.username|json_script:"current-user-name" }}

    <script>
        const otherUserId = JSON.parse(document.getElementById('other-user-id').textContent);
        const currentUserName = JSON.parse(document.getElementById('current-user-name').textContent);

        const chatLog = document.querySelector('#chat-log');
        const chatForm = document.querySelector('#chat-form');
        const chatMessageInput = document.querySelector('#chat-message-input');
        const chatImageInput = document.querySelector('#chat-image-input');
        const chatMessageSubmit = document.querySelector('#chat-message-submit');

        // --- ç”»é¢å¤–ã‚¯ãƒªãƒƒã‚¯ã§JSãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‰ã˜ã‚‹ ---
        document.addEventListener('click', function () {
            document.querySelectorAll('.js-chat-menu').forEach(el => el.classList.add('hidden'));
        });

        // --- ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢è‡ªå‹•ãƒªã‚µã‚¤ã‚º ---
        chatMessageInput.addEventListener('input', function () {
            this.style.height = 'auto';
            this.style.height = (this.style.scrollHeight) + 'px';
            if (this.scrollHeight > 150) this.style.overflowY = "scroll";
            else this.style.overflowY = "hidden";
        });

        chatMessageInput.addEventListener('keydown', function (e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                chatMessageSubmit.click();
            }
        });

        // --- XSSå¯¾ç­– ---
        function escapeHtml(text) {
            if (!text) return text;
            return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
        }

        // --- WebSocket ---
        const ws_scheme = window.location.protocol === "https:" ? "wss" : "ws";
        const chatSocket = new WebSocket(
            ws_scheme + '://' + window.location.host + '/ws/chat/dm/' + otherUserId + '/'
        );

        chatSocket.onopen = function (e) {
            console.log('Connected');
        };
        chatSocket.onclose = function (e) {
            console.error('Disconnected');
        };

        chatSocket.onmessage = function (e) {
            const data = JSON.parse(e.data);
            if (data.type === 'delete') {
                const msgElement = document.getElementById('msg-' + data.message_id);
                if (msgElement) msgElement.remove();
            } else {
                appendMessage(data.sender, data.message, data.image_url, data.id);
            }
        };

        // --- å‰Šé™¤ãƒªã‚¯ã‚¨ã‚¹ãƒˆ ---
        function deleteMessage(msgId) {
            // ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã¯HTML/JSã®å‘¼ã³å‡ºã—å…ƒã§è¡Œã†ãŸã‚ã€ã“ã“ã¯å³å®Ÿè¡Œ
            const formData = new FormData();
            formData.append('message_id', msgId);
            fetch('/api/delete-message/', {
                method: 'POST',
                body: formData,
                headers: {'X-CSRFToken': getCookie('csrftoken')}
            }).then(r => {
                if (!r.ok) alert('å‰Šé™¤å¤±æ•—');
            });
        }

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // --- é€ä¿¡å‡¦ç† ---
        chatForm.onsubmit = function (e) {
            e.preventDefault();
            const message = chatMessageInput.value;
            const imageFile = chatImageInput.files[0];

            if (message.trim() === '' && !imageFile) return;

            const formData = new FormData();
            formData.append('recipient_id', otherUserId);
            formData.append('message', message);
            if (imageFile) {
                formData.append('image', imageFile);
            }

            const apiUrl = '/api/post-dm-message/';

            fetch(apiUrl, {
                method: 'POST',
                body: formData,
                headers: {'X-CSRFToken': getCookie('csrftoken')}
            })
                .then(response => {
                    if (response.ok) {
                        chatMessageInput.value = '';
                        chatImageInput.value = '';
                        chatMessageInput.style.height = 'auto';
                    } else {
                        alert('é€ä¿¡å¤±æ•—');
                    }
                })
                .catch(error => console.error('é€šä¿¡ã‚¨ãƒ©ãƒ¼:', error));
        };

        // --- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¿½åŠ  (JSç‰ˆãƒ¡ãƒ‹ãƒ¥ãƒ¼å®Ÿè£…) ---
        function appendMessage(sender, message, imageUrl, msgId) {
            const isMe = (sender === currentUserName);

            const messageDiv = document.createElement('div');
            if (msgId) messageDiv.id = 'msg-' + msgId;
            messageDiv.className = 'text-base mb-4 relative group' + (isMe ? ' text-right' : '');

            const senderP = document.createElement('p');
            senderP.className = 'font-bold text-sm text-gray-500 mb-1';
            senderP.textContent = sender;

            const bubbleContainer = document.createElement('div');
            bubbleContainer.className = 'inline-block relative text-left';

            const contentP = document.createElement('div');
            contentP.className = (isMe ? 'bg-blue-500 text-white' : 'bg-gray-200') +
                ' p-3 rounded-t-xl' +
                (isMe ? ' rounded-bl-xl' : ' rounded-br-xl') +
                ' text-left break-words max-w-xs';

            // â˜…ä¿®æ­£: ç”»åƒå‡¦ç† (aã‚¿ã‚°ã‚’ä½œã‚‰ãšimgã®ã¿)
            if (imageUrl) {
                let fullImageUrl = imageUrl;
                if (!imageUrl.startsWith('http')) fullImageUrl = window.location.origin + imageUrl;

                const img = document.createElement('img');
                img.src = fullImageUrl;
                img.className = "max-w-full h-auto rounded-lg mb-1 pointer-events-none"; // ã‚¯ãƒªãƒƒã‚¯é€é
                img.style.maxHeight = "200px";
                contentP.appendChild(img);
            }

            // ãƒ†ã‚­ã‚¹ãƒˆå‡¦ç†
            function urlify(text) {
                const urlRegex = /(https?:\/\/[^\s]+)/g;
                return text.replace(urlRegex, '<a href="$&" target="_blank" class="underline hover:text-blue-200" onclick="event.stopPropagation()">$&</a>').replace(/\n/g, '<br>');
            }

            if (message) {
                const textSpan = document.createElement('span');
                const safeText = escapeHtml(message);
                textSpan.innerHTML = urlify(safeText);
                contentP.appendChild(textSpan);
            }

            bubbleContainer.appendChild(contentP);

            // â˜…ä¿®æ­£: JSã§ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’ä½œæˆ (Alpineæœªä½¿ç”¨)
            const needsMenu = (isMe && msgId) || imageUrl;

            if (needsMenu) {
                contentP.style.cursor = 'pointer';

                const menuDiv = document.createElement('div');
                menuDiv.className = 'hidden absolute z-20 bg-white shadow-xl border border-gray-200 rounded-lg p-1 min-w-[140px] flex flex-col gap-1 mt-1 js-chat-menu';

                if (isMe) menuDiv.style.right = '0';
                else menuDiv.style.left = '0';

                // ç”»åƒæ‹¡å¤§ãƒœã‚¿ãƒ³
                if (imageUrl) {
                    let fullImageUrl = imageUrl;
                    if (!imageUrl.startsWith('http')) fullImageUrl = window.location.origin + imageUrl;

                    const viewBtn = document.createElement('a');
                    viewBtn.href = fullImageUrl;
                    viewBtn.target = "_blank";
                    viewBtn.innerHTML = 'ğŸ” ç”»åƒã‚’æ‹¡å¤§';
                    viewBtn.className = 'block text-left text-sm text-gray-700 px-3 py-2 hover:bg-gray-100 rounded text-decoration-none';
                    viewBtn.onclick = function (e) {
                        e.stopPropagation();
                    };
                    menuDiv.appendChild(viewBtn);
                }

                // å‰Šé™¤ãƒœã‚¿ãƒ³
                if (isMe && msgId) {
                    const delBtn = document.createElement('button');
                    delBtn.innerHTML = 'ğŸ—‘ï¸ å‰Šé™¤ã™ã‚‹';
                    delBtn.className = 'block w-full text-left text-sm text-red-600 px-3 py-2 hover:bg-red-50 rounded';
                    delBtn.onclick = function (e) {
                        e.stopPropagation();
                        if (confirm('æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                            menuDiv.classList.add('hidden');
                            deleteMessage(msgId);
                        }
                    };
                    menuDiv.appendChild(delBtn);
                }

                bubbleContainer.appendChild(menuDiv);

                // ãƒ¡ãƒ‹ãƒ¥ãƒ¼é–‹é–‰ã‚¤ãƒ™ãƒ³ãƒˆ
                contentP.onclick = function (e) {
                    e.stopPropagation();
                    // ä»–ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‰ã˜ã‚‹
                    document.querySelectorAll('.js-chat-menu').forEach(el => {
                        if (el !== menuDiv) el.classList.add('hidden');
                    });
                    // ãƒˆã‚°ãƒ«
                    if (menuDiv.classList.contains('hidden')) menuDiv.classList.remove('hidden');
                    else menuDiv.classList.add('hidden');
                };
            }

            messageDiv.appendChild(senderP);
            messageDiv.appendChild(bubbleContainer);
            chatLog.appendChild(messageDiv);
            chatLog.scrollTop = chatLog.scrollHeight;
        }

        window.onload = function () {
            chatLog.scrollTop = chatLog.scrollHeight;
        };
    </script>
{% endblock %}