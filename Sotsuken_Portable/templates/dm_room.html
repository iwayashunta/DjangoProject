{% extends "base.html" %}
{% block title %}チャット - {{ other_user.full_name|default:other_user.username }}{% endblock %}
{% block header_title %}{{ other_user.full_name|default:other_user.username }}{% endblock %}

{% block content %}
    <div class="flex flex-col h-[75vh]">
        <div id="chat-log" class="flex-1 bg-white p-4 rounded-t-xl shadow-inner mb-4 overflow-y-auto space-y-4">
            {# 過去ログの表示 (Messageモデルのフィールド名に合わせる) #}
            {% for msg in messages %}
                <div class="text-base {% if msg.sender == user %}text-right{% endif %}">
                    <p class="font-bold text-sm text-gray-500">{{ msg.sender.full_name|default:msg.sender.username }}</p>
                    <p class="{% if msg.sender == user %}bg-blue-500 text-white{% else %}bg-gray-200{% endif %} p-3 rounded-t-xl {% if msg.sender == user %}rounded-bl-xl{% else %}rounded-br-xl{% endif %} inline-block max-w-xs text-left">
                        {{ msg.content|urlize|linebreaksbr }}
                    </p>
                </div>
            {% endfor %}
        </div>
        <form id="chat-form" class="flex" autocomplete="off">
            <input type="text" id="chat-message-input"
                   class="flex-1 p-3 border border-gray-300 rounded-l-xl focus:outline-none focus:ring-2 focus:ring-blue-500"
                   placeholder="メッセージを入力...">
            <button type="submit" id="chat-message-submit"
                    class="bg-blue-600 text-white p-3 rounded-r-xl hover:bg-blue-700 font-semibold">送信
            </button>
        </form>
    </div>

    {# --- JavaScriptに渡すデータを変更 --- #}
    {{ other_user.id|json_script:"other-user-id" }}
    {{ user.full_name|default:user.username|json_script:"current-user-name" }}

    <script>
        const otherUserId = JSON.parse(document.getElementById('other-user-id').textContent);
        const currentUserName = JSON.parse(document.getElementById('current-user-name').textContent);
        
        const chatLog = document.querySelector('#chat-log');
        const chatForm = document.querySelector('#chat-form');
        const chatMessageInput = document.querySelector('#chat-message-input');

        // ★ 接続先URLを変更
        const chatSocket = new WebSocket(
            'ws://' + window.location.host + '/ws/chat/dm/' + otherUserId + '/'
        );
        
        chatSocket.onopen = function (e) {
            console.log('Chat socket connected successfully');
        };

        chatSocket.onclose = function (e) {
            console.error('WebSocket接続が切れました。');
        };

        chatSocket.onmessage = function (e) {
            const data = JSON.parse(e.data);
            appendMessage(data.sender, data.message);
        };

        chatForm.onsubmit = function (e) {
            e.preventDefault();
            const message = chatMessageInput.value;
            if (message.trim() !== '') {
                chatSocket.send(JSON.stringify({
                    'message': message
                }));
                chatMessageInput.value = '';
            }
        };

        function appendMessage(sender, message) {
            const isMe = (sender === currentUserName);

            const messageDiv = document.createElement('div');
            messageDiv.className = 'text-base' + (isMe ? ' text-right' : '');

            const senderP = document.createElement('p');
            senderP.className = 'font-bold text-sm text-gray-500 mb-1';
            senderP.textContent = sender;

            const contentP = document.createElement('p');
            contentP.className = (isMe ? 'bg-blue-500 text-white' : 'bg-gray-200') +
                ' p-3 rounded-t-xl' +
                (isMe ? ' rounded-bl-xl' : ' rounded-br-xl') +
                ' inline-block max-w-xs text-left';

            function urlify(text) {
                const urlRegex = /(https?:\/\/[^\s]+)/g;
                // リンクをaタグに変換し、改行を<br>タグに変換する
                return text
                    .replace(urlRegex, '<a href="$&" target="_blank" class="text-white underline hover:text-blue-200">$&</a>')
                    .replace(/\n/g, '<br>');
            }

            contentP.innerHTML = urlify(message);

            messageDiv.appendChild(senderP);
            messageDiv.appendChild(contentP);
            chatLog.appendChild(messageDiv);

            chatLog.scrollTop = chatLog.scrollHeight;
        }


        window.onload = function() {
            chatLog.scrollTop = chatLog.scrollHeight;
        };
    </script>
{% endblock %}