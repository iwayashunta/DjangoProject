{% extends 'base.html' %}
{% load static %}

{% block title %}é¿é›£æ‰€ç®¡ç†{% endblock %}
{% block header_title %}é¿é›£æ‰€ç®¡ç†{% endblock %}

{% block content %}
    <div class="p-4 md:p-8 max-w-4xl mx-auto">

        <!-- æ–°è¦é¿é›£æ‰€ç™»éŒ²ãƒ•ã‚©ãƒ¼ãƒ  -->
        <form method="post" class="bg-white p-6 rounded-xl shadow-lg mb-8" onsubmit="return disableButton(this)">
            {% csrf_token %}
            <h3 class="text-lg font-semibold mb-4 text-orange-700">æ–°è¦é¿é›£æ‰€ã®ç™»éŒ²</h3>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">

                <!-- ç®¡ç†ID -->
                <div class="mb-2">
                    <label for="{{ form.management_id.id_for_label }}"
                           class="block text-sm font-medium text-gray-700">{{ form.management_id.label }}</label>
                    {{ form.management_id }}
                    <p class="text-xs text-gray-500 mt-1">
                        â€»IDã‚’å¤‰æ›´ã™ã‚‹ã¨é–¢é€£ãƒ‡ãƒ¼ã‚¿ã¨ã®ãƒªãƒ³ã‚¯ãŒåˆ‡ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã®ã§ã”æ³¨æ„ãã ã•ã„ã€‚</p>
                </div>

                <!-- é–‹è¨­çŠ¶æ³ -->
                <div class="mb-2">
                    <label for="{{ form.opening_status.id_for_label }}"
                           class="block text-sm font-medium text-gray-700">{{ form.opening_status.label }}</label>
                    {{ form.opening_status }}
                </div>

                <!-- æ—¢å­˜ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ (name, address, max_capacity, is_pet_friendly) -->
                <div class="mb-2">
                    <label for="{{ form.name.id_for_label }}"
                           class="block text-sm font-medium text-gray-700">{{ form.name.label }}</label>
                    {{ form.name }}
                    {% if form.name.errors %}
                        <p class="text-red-500 text-xs mt-1">{{ form.name.errors.0 }}</p>{% endif %}
                </div>

                <div class="mb-2">
                    <label for="{{ form.address.id_for_label }}"
                           class="block text-sm font-medium text-gray-700">{{ form.address.label }}</label>
                    {{ form.address }}
                </div>

                <div class="mb-2">
                    <label for="{{ form.max_capacity.id_for_label }}"
                           class="block text-sm font-medium text-gray-700">{{ form.max_capacity.label }}</label>
                    {{ form.max_capacity }}
                </div>

                <!-- â˜…â˜…â˜… è¿½åŠ : ç¾åœ¨ã®åå®¹äººæ•° â˜…â˜…â˜… -->
                <div class="mb-2">
                    <label for="{{ form.current_occupancy.id_for_label }}"
                           class="block text-sm font-medium text-gray-700">{{ form.current_occupancy.label }}</label>
                    {{ form.current_occupancy }}
                </div>


                <div class="mb-2 flex items-center h-full pt-6">
                    {{ form.is_pet_friendly }}
                    <label for="{{ form.is_pet_friendly.id_for_label }}"
                           class="ml-2 block text-sm font-medium text-gray-700">
                        ãƒšãƒƒãƒˆåŒä¼´å¯
                    </label>
                </div>

                <!-- â˜…â˜…â˜… è¿½åŠ : ç·¯åº¦ãƒ»çµŒåº¦å…¥åŠ›ã‚¨ãƒªã‚¢ â˜…â˜…â˜… -->
                <div class="md:col-span-2 border-t pt-4 mt-2">
                    <label class="block text-sm font-bold text-gray-700 mb-2">ä½ç½®æƒ…å ± (ãƒ”ãƒ³ç”¨)</label>

                    <div class="flex gap-4 items-end">
                        <div class="flex-1">
                            <label class="text-xs text-gray-500">ç·¯åº¦</label>
                            {{ form.latitude }}
                        </div>
                        <div class="flex-1">
                            <label class="text-xs text-gray-500">çµŒåº¦</label>
                            {{ form.longitude }}
                        </div>

                        <!-- ç¾åœ¨åœ°å–å¾—ãƒœã‚¿ãƒ³ -->
                        <button type="button" onclick="getLocation()"
                                class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 text-sm font-bold h-10 mb-0.5">
                            ğŸ“ ç¾åœ¨åœ°ã‚’å–å¾—
                        </button>
                    </div>
                    <p class="text-xs text-gray-500 mt-1">â€»ç©ºæ¬„ã§ã‚‚ç™»éŒ²ã§ãã¾ã™ã€‚å…¥åŠ›ã™ã‚‹ã¨åœ°å›³ã«ãƒ”ãƒ³ãŒç«‹ã¡ã¾ã™ã€‚</p>
                </div>
            </div>

            <button type="submit"
                    class="mt-6 w-full bg-orange-500 text-white p-3 rounded-lg hover:bg-orange-600 transition-colors font-semibold">
                ã“ã®å†…å®¹ã§ç™»éŒ²ã™ã‚‹
            </button>
        </form>

        <!-- æ—¢å­˜é¿é›£æ‰€ãƒªã‚¹ãƒˆ -->
        <div class="bg-white p-6 rounded-xl shadow-lg">
            <h3 class="text-lg font-semibold mb-2">ç™»éŒ²æ¸ˆã¿é¿é›£æ‰€ãƒªã‚¹ãƒˆ</h3>
            <form method="get" class="flex gap-2" onsubmit="return disableButton(this)">
                {{ search_form.q }}
                <button type="submit"
                        class="bg-blue-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-blue-700 shadow-sm">
                    æ¤œç´¢
                </button>
                <a href="{% url 'Sotsuken_Portable:shelter_management' %}"
                   class="bg-gray-200 text-gray-700 px-3 py-2 rounded-lg hover:bg-gray-300 flex items-center">
                    ãƒªã‚»ãƒƒãƒˆ
                </a>
            </form>
        </div>
        <div class="overflow-x-auto">
            <table class="w-full min-w-[700px]">
                <thead>
                <tr class="border-b">
                    <th class="p-2 text-left w-24">ID</th>
                    <th class="p-2 text-left">é¿é›£æ‰€å</th>
                    <th class="p-2 text-center">æœ€å¤§åå®¹äººæ•°</th>
                    <th class="p-2 text-center">ç¾åœ¨ã®åå®¹äººæ•°</th>
                    <th class="p-2 text-center">ãƒšãƒƒãƒˆå¯å¦</th>
                    <th class="p-2 text-center">æ“ä½œ</th>
                </tr>
                </thead>
                <tbody>
                {% for shelter in shelter_list %}
                    <tr class="border-b hover:bg-gray-50">
                        <td class="p-2 font-mono text-sm text-gray-600 font-bold">
                            {{ shelter.management_id }}
                        </td>

                        <td class="p-2 font-semibold">
                            {{ shelter.name }}
                            <div class="text-xs text-gray-400 font-normal">{{ shelter.address|truncatechars:20 }}</div>
                        </td>
                        <td class="p-2 text-center">{{ shelter.max_capacity }}äºº</td>
                        <td class="p-2 text-center">{{ shelter.current_occupancy }}äºº</td>
                        <td class="p-2 text-center">
                            {% if shelter.is_pet_friendly %}
                                <span class="inline-flex items-center px-3 py-1 text-sm rounded-full font-semibold bg-cyan-100 text-cyan-800">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" viewBox="0 0 20 20"
                                     fill="currentColor">
                                    <path fill-rule="evenodd"
                                          d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
                                          clip-rule="evenodd"/>
                                </svg>
                                å¯
                            </span>
                            {% else %}
                                <span class="inline-flex items-center px-3 py-1 text-sm rounded-full font-semibold bg-gray-200 text-gray-700">
                                ä¸å¯
                            </span>
                            {% endif %}
                        </td>
                        <td class="p-2 text-center space-x-2">
                            <!-- æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã§å®Ÿè£…ã™ã‚‹ç·¨é›†ãƒ»å‰Šé™¤ãƒœã‚¿ãƒ³ã‚’é…ç½® -->
                            <a href="{% url 'Sotsuken_Portable:shelter_edit' shelter.management_id %}"
                               class="inline-block bg-blue-500 text-white text-xs font-bold py-1 px-3 rounded-md hover:bg-blue-700">ç·¨é›†</a>
                            <a href="{% url 'Sotsuken_Portable:shelter_delete' shelter.management_id %}"
                               class="inline-block bg-red-500 text-white text-xs font-bold py-1 px-3 rounded-md hover:bg-red-700">å‰Šé™¤</a>
                        </td>
                    </tr>
                {% empty %}
                    <tr>
                        <td colspan="5" class="p-4 text-center text-gray-500">ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹é¿é›£æ‰€ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    </div>
{% endblock %}

{% block body_extra %}
    <style>
        /* ãƒ•ã‚©ãƒ¼ãƒ ã®å…¥åŠ›æ¬„ã«TailwindCSSã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’ä¸€æ‹¬ã§é©ç”¨ */
        input[type="text"], input[type="number"], input[type="email"], input[type="url"], select {
            @apply mt-1 p-2 w-full border border-gray-300 rounded-lg;
        }

        input[type="checkbox"] {
            @apply h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500;
        }
    </style>

    <!-- â˜…â˜…â˜… è¿½åŠ : ä½ç½®æƒ…å ±å–å¾—ã‚¹ã‚¯ãƒªãƒ—ãƒˆ â˜…â˜…â˜… -->
    <script>
        function getLocation() {
            // ãƒ‡ãƒ¢ç”¨åº§æ¨™ï¼ˆåºƒå³¶å¸‚å—åŒºå½¹æ‰€ï¼‰
            const DEMO_LAT = 34.380780;
            const DEMO_LON = 132.468517;

            const btn = document.querySelector('button[onclick="getLocation()"]');
            const originalText = btn.innerText;
            btn.innerText = "å–å¾—ä¸­...";
            btn.disabled = true;

            // å…±é€šã®å…¥åŠ›å‡¦ç†é–¢æ•°
            const setLocation = (lat, lon, isDemo = false) => {
                document.getElementById('id_latitude').value = lat.toFixed(6);
                document.getElementById('id_longitude').value = lon.toFixed(6);

                if (isDemo) {
                    alert("ã€ãƒ‡ãƒ¢ãƒ¢ãƒ¼ãƒ‰ã€‘ä½ç½®æƒ…å ±ãŒå–å¾—ã§ããªã„ãŸã‚ã€\nè‡ªå‹•çš„ã«ãƒ‡ãƒ¢åœ°ç‚¹ã‚’è¨­å®šã—ã¾ã—ãŸã€‚");
                    btn.innerText = "ãƒ‡ãƒ¢åœ°ç‚¹è¨­å®š";
                } else {
                    btn.innerText = "å®Œäº†ï¼";
                }

                setTimeout(() => {
                    btn.innerText = originalText;
                    btn.disabled = false;
                }, 2000);
            };

            if (!navigator.geolocation) {
                // éå¯¾å¿œãƒ–ãƒ©ã‚¦ã‚¶ãªã‚‰å³ãƒ‡ãƒ¢
                setLocation(DEMO_LAT, DEMO_LON, true);
                return;
            }

            navigator.geolocation.getCurrentPosition(
                // æˆåŠŸæ™‚
                (position) => {
                    setLocation(position.coords.latitude, position.coords.longitude, false);
                },
                // å¤±æ•—æ™‚ï¼ˆãƒ‡ãƒ¢ã¸ï¼‰
                (error) => {
                    console.warn("ä½ç½®æƒ…å ±ã‚¨ãƒ©ãƒ¼:", error);
                    setLocation(DEMO_LAT, DEMO_LON, true);
                },
                {
                    enableHighAccuracy: true,
                    timeout: 5000,
                    maximumAge: 0
                }
            );
        }
    </script>
{% endblock %}
